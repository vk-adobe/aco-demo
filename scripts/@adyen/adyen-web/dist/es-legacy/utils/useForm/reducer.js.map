{"version":3,"file":"reducer.js","sources":["../../../../src/utils/useForm/reducer.ts"],"sourcesContent":["const omitKeys = (obj, omit) =>\n    Object.keys(obj)\n        .filter(k => !omit.includes(k))\n        .reduce((a, c) => {\n            a[c] = obj[c];\n            return a;\n        }, {});\n\nconst addKeys = (obj, add, initialValue, defaultData, pendingData) =>\n    add.reduce((a, c) => ({ ...a, [c]: a[c] ?? pendingData?.[c] ?? defaultData?.[c] ?? initialValue }), obj);\n\n/**\n * Processes default data and sets as default in state\n */\nexport function init({ schema, defaultData, processField, fieldProblems }) {\n    const getProcessedState = fieldKey => {\n        if (typeof defaultData[fieldKey] === 'undefined')\n            return { valid: false, errors: null, data: null, fieldProblems: fieldProblems?.[fieldKey] ?? null };\n\n        const [formattedValue, validationResult] = processField(\n            { key: fieldKey, value: defaultData[fieldKey], mode: 'blur' },\n            { state: { data: defaultData } }\n        );\n\n        return {\n            valid: (validationResult.isValid && !fieldProblems?.[fieldKey]) || false,\n            errors: validationResult.hasError() ? validationResult.getError() : null,\n            data: formattedValue,\n            fieldProblems: fieldProblems?.[fieldKey] ?? null\n        };\n    };\n\n    const formData = schema.reduce(\n        (acc: any, fieldKey) => {\n            const { valid, errors, data, fieldProblems } = getProcessedState(fieldKey);\n\n            return {\n                valid: { ...acc.valid, [fieldKey]: valid },\n                errors: { ...acc.errors, [fieldKey]: errors },\n                data: { ...acc.data, [fieldKey]: data },\n                fieldProblems: { ...acc.fieldProblems, [fieldKey]: fieldProblems }\n            };\n        },\n        { data: {}, valid: {}, errors: {}, fieldProblems: {} }\n    );\n\n    return {\n        schema,\n        data: formData.data,\n        valid: formData.valid,\n        errors: formData.errors,\n        fieldProblems: formData.fieldProblems\n    };\n}\n\nexport function getReducer(processField) {\n    return function reducer(state, { type, key, value, mode, schema, defaultData, formValue, selectedSchema, fieldProblems, data }) {\n        const validationSchema: string[] = selectedSchema || state.schema;\n\n        switch (type) {\n            case 'setData': {\n                return { ...state, data: { ...state['data'], [key]: value } };\n            }\n            case 'mergeData': {\n                return { ...state, data: { ...state['data'], ...data } };\n            }\n            case 'setValid': {\n                return { ...state, valid: { ...state['valid'], [key]: value } };\n            }\n            case 'setErrors': {\n                return { ...state, errors: { ...state['errors'], [key]: value } };\n            }\n            case 'setFieldProblems': {\n                return (\n                    state?.schema?.reduce(\n                        (acc, key) => ({\n                            ...acc,\n                            fieldProblems: { ...state['fieldProblems'], [key]: fieldProblems?.[key] ?? null },\n                            valid: { ...state['valid'], [key]: state['valid']?.[key] && !fieldProblems[key] }\n                        }),\n                        state\n                    ) ?? state\n                );\n            }\n            case 'updateField': {\n                const [formattedValue, validation] = processField({ key, value, mode }, { state });\n                const oldValue = state.data[key];\n                const fieldProblems = { ...state.fieldProblems };\n                if (oldValue !== formattedValue) {\n                    fieldProblems[key] = null;\n                }\n                return {\n                    ...state,\n                    data: { ...state['data'], [key]: formattedValue },\n                    errors: { ...state['errors'], [key]: validation.hasError() ? validation.getError() : null },\n                    valid: { ...state['valid'], [key]: (validation.isValid && !fieldProblems[key]) || false },\n                    fieldProblems\n                };\n            }\n            case 'mergeForm': {\n                // To provide a uniform result from forms even if there are multiple levels of nested forms are present\n                const mergedState = {\n                    ...state,\n                    data: { ...state['data'], ...formValue['data'] },\n                    errors: { ...state['errors'], ...formValue['errors'] },\n                    valid: { ...state['valid'], ...formValue['valid'] },\n                    fieldProblems: { ...state['fieldProblems'], ...formValue['fieldProblems'] }\n                };\n                if (mergedState['valid']) {\n                    mergedState.isValid = Object.values(mergedState.valid).every(isValid => isValid);\n                }\n                return mergedState;\n            }\n            case 'setSchema': {\n                const defaultState = init({ schema, defaultData, processField, fieldProblems });\n                const removedSchemaFields = state.schema.filter(x => !schema.includes(x));\n                const newSchemaFields = schema.filter(x => !state.schema.includes(x));\n\n                // if we remove a key from the schema we also lost the latest value of the field\n                // to prevent this we have to store the value in a local state so we can recover it when the key is re-added to the schema\n                const local = {\n                    data: omitKeys(state.data, newSchemaFields),\n                    errors: omitKeys(state.errors, newSchemaFields),\n                    valid: omitKeys(state.valid, newSchemaFields)\n                };\n\n                // reindex data and validation according to the new schema\n                const data = addKeys(omitKeys(state.data, removedSchemaFields), newSchemaFields, null, defaultState.data, state.local?.data);\n                const valid = addKeys(omitKeys(state.valid, removedSchemaFields), newSchemaFields, false, defaultState.valid, state.local?.valid);\n                const errors = addKeys(omitKeys(state.errors, removedSchemaFields), newSchemaFields, null, defaultState.errors, state.local?.errors);\n\n                return { ...state, schema, data, valid, errors, local };\n            }\n            case 'validateForm': {\n                const formValidation = validationSchema.reduce(\n                    (acc, cur) => {\n                        const [, validation] = processField({ key: cur, value: state.data[cur], mode: 'blur' }, { state });\n                        return {\n                            valid: { ...acc['valid'], [cur]: (validation.isValid && !state.fieldProblems[cur]) || false },\n                            errors: { ...acc['errors'], [cur]: validation.hasError(true) ? validation.getError(true) : null }\n                        };\n                    },\n                    { valid: state.valid, errors: state.errors }\n                );\n\n                return { ...state, valid: formValidation.valid, errors: formValidation.errors };\n            }\n            default:\n                throw new Error('Undefined useForm action');\n        }\n    };\n}\n"],"names":["omitKeys","obj","omit","Object","keys","filter","k","includes","reduce","a","c","addKeys","add","initialValue","defaultData","pendingData","_object_spread_props","init","schema","processField","fieldProblems","getProcessedState","fieldKey","valid","errors","data","formattedValue","validationResult","key","value","mode","state","isValid","hasError","getError","formData","acc","_object_spread","getReducer","type","formValue","selectedSchema","validationSchema","validation","oldValue","mergedState","values","every","defaultState","removedSchemaFields","x","newSchemaFields","local","formValidation","cur","Error"],"mappings":"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"}