{"version":3,"file":"CashAppPay.js","sources":["../../../../src/components/CashAppPay/CashAppPay.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport { CoreProvider } from '../../core/Context/CoreProvider';\nimport { CashAppComponent } from './components/CashAppComponent';\nimport CashAppService from './services/CashAppService';\nimport { CashAppSdkLoader } from './services/CashAppSdkLoader';\nimport { CashAppPayElementData, CashAppPayConfiguration, CashAppPayEventData } from './types';\nimport { ICashAppService } from './services/types';\nimport defaultProps from './defaultProps';\nimport RedirectButton from '../internal/RedirectButton';\nimport { payAmountLabel } from '../internal/PayButton';\nimport { TxVariants } from '../tx-variants';\nimport type { ICore } from '../../core/types';\nimport { PREFIX } from '../internal/Icon/constants';\n\nexport class CashAppPay extends UIElement<CashAppPayConfiguration> {\n    public static type = TxVariants.cashapp;\n\n    private readonly cashAppService: ICashAppService | undefined;\n\n    protected static defaultProps = defaultProps;\n\n    constructor(checkout: ICore, props?: CashAppPayConfiguration) {\n        super(checkout, props);\n\n        if (this.props.enableStoreDetails && this.props.storePaymentMethod) {\n            console.warn(\n                'CashAppPay: enableStoreDetails AND storePaymentMethod configuration properties should not be used together. That can lead to undesired behavior.'\n            );\n        }\n\n        if (this.props.storedPaymentMethodId) {\n            return;\n        }\n\n        this.cashAppService = new CashAppService(new CashAppSdkLoader(), {\n            storePaymentMethod: this.props.storePaymentMethod,\n            useCashAppButtonUi: this.props.showPayButton,\n            environment: this.props.environment,\n            amount: this.props.amount,\n            redirectURL: this.props.redirectURL,\n            clientId: this.props.configuration?.clientId,\n            scopeId: this.props.configuration?.scopeId,\n            button: this.props.button,\n            referenceId: this.props.referenceId\n        });\n    }\n\n    public formatProps(props: CashAppPayConfiguration) {\n        return {\n            ...props,\n            enableStoreDetails: props.session?.configuration?.enableStoreDetails || props.enableStoreDetails\n        };\n    }\n\n    public formatData(): CashAppPayElementData {\n        const { shopperWantsToStore, grantId, onFileGrantId, cashTag, customerId } = this.state.data || {};\n        const { storePaymentMethod: storePaymentMethodSetByMerchant, storedPaymentMethodId } = this.props;\n\n        /**\n         * We include 'storePaymentMethod' flag if we either Display the Checkbox OR if it is non-sessions flow AND the merchant wants to store the payment method\n         */\n        const includeStorePaymentMethod = this.props.enableStoreDetails || (!this.props.session && storePaymentMethodSetByMerchant);\n\n        if (storedPaymentMethodId) {\n            return {\n                paymentMethod: {\n                    type: CashAppPay.type,\n                    storedPaymentMethodId\n                }\n            };\n        }\n\n        const shouldAddOnFileProperties = onFileGrantId && cashTag;\n\n        return {\n            paymentMethod: {\n                type: CashAppPay.type,\n                ...(grantId && { grantId }),\n                ...(customerId && { customerId }),\n                ...(shouldAddOnFileProperties && { onFileGrantId, cashtag: cashTag })\n            },\n            ...(includeStorePaymentMethod && { storePaymentMethod: storePaymentMethodSetByMerchant || shopperWantsToStore })\n        };\n    }\n\n    get displayName() {\n        if (this.props.storedPaymentMethodId && this.props.cashtag) {\n            return this.props.cashtag;\n        }\n        return this.props.name;\n    }\n\n    get additionalInfo() {\n        return this.props.storedPaymentMethodId ? 'Cash App Pay' : '';\n    }\n\n    public submit = () => {\n        const { onClick, storedPaymentMethodId } = this.props;\n\n        if (storedPaymentMethodId) {\n            super.submit();\n            return;\n        }\n\n        let onClickPromiseRejected = false;\n\n        new Promise<void>((resolve, reject) => onClick({ resolve, reject }))\n            .catch(() => {\n                onClickPromiseRejected = true;\n                throw Error('onClick rejected');\n            })\n            .then(() => {\n                return this.cashAppService.createCustomerRequest();\n            })\n            .then(() => {\n                this.cashAppService.begin();\n            })\n            .catch(error => {\n                if (onClickPromiseRejected) {\n                    // Swallow exception triggered by onClick reject\n                    return;\n                }\n                this.handleError(error);\n            });\n    };\n\n    public get isValid(): boolean {\n        return true;\n    }\n\n    private handleOnChangeStoreDetails = (storePayment: boolean) => {\n        const data = { ...this.state.data, shopperWantsToStore: storePayment };\n        this.setState({ data });\n    };\n\n    private handleAuthorize = (cashAppPaymentData: CashAppPayEventData): void => {\n        const data = { ...this.state.data, ...cashAppPaymentData };\n        this.setState({ data, valid: {}, errors: {}, isValid: true });\n        super.submit();\n    };\n\n    render() {\n        return (\n            <CoreProvider i18n={this.props.i18n} resources={this.resources} loadingContext={this.props.loadingContext}>\n                {this.props.storedPaymentMethodId ? (\n                    <RedirectButton\n                        showPayButton={this.props.showPayButton}\n                        label={payAmountLabel(this.props.i18n, this.props.amount)}\n                        icon={this.resources?.getImage({ imageFolder: 'components/' })(`${PREFIX}lock`)}\n                        name={this.displayName}\n                        amount={this.props.amount}\n                        payButton={this.payButton}\n                        onSubmit={this.submit}\n                        ref={ref => {\n                            this.componentRef = ref;\n                        }}\n                    />\n                ) : (\n                    <CashAppComponent\n                        ref={ref => {\n                            this.componentRef = ref;\n                        }}\n                        enableStoreDetails={this.props.enableStoreDetails}\n                        cashAppService={this.cashAppService}\n                        onChangeStoreDetails={this.handleOnChangeStoreDetails}\n                        onError={this.handleError}\n                        onClick={this.submit}\n                        onAuthorize={this.handleAuthorize}\n                    />\n                )}\n            </CoreProvider>\n        );\n    }\n}\n\nexport default CashAppPay;\n"],"names":["CashAppPay","UIElement","formatProps","props","_object_spread_props","enableStoreDetails","session","configuration","formatData","shopperWantsToStore","grantId","onFileGrantId","cashTag","customerId","this","state","data","storePaymentMethod","storePaymentMethodSetByMerchant","storedPaymentMethodId","includeStorePaymentMethod","paymentMethod","type","_object_spread","cashtag","displayName","name","additionalInfo","isValid","render","_this_resources","h","CoreProvider","i18n","resources","loadingContext","RedirectButton","showPayButton","label","payAmountLabel","amount","icon","getImage","imageFolder","PREFIX","payButton","onSubmit","submit","ref","componentRef","CashAppComponent","cashAppService","onChangeStoreDetails","handleOnChangeStoreDetails","onError","handleError","onClick","onAuthorize","handleAuthorize","constructor","checkout","_this_props_configuration","_this_props_configuration1","super","_define_property","onClickPromiseRejected","Promise","resolve","reject","catch","Error","then","createCustomerRequest","begin","error","storePayment","setState","cashAppPaymentData","valid","errors","console","warn","CashAppService","CashAppSdkLoader","useCashAppButtonUi","environment","redirectURL","clientId","scopeId","button","referenceId","TxVariants","cashapp","defaultProps"],"mappings":"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"}