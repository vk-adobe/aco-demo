{"version":3,"file":"AmazonPay.js","sources":["../../../../src/components/AmazonPay/AmazonPay.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport { CoreProvider } from '../../core/Context/CoreProvider';\nimport collectBrowserInfo from '../../utils/browserInfo';\nimport AmazonPayComponent from './components/AmazonPayComponent';\nimport { AmazonPayElementData, AmazonPayConfiguration, CheckoutDetailsRequest } from './types';\nimport defaultProps from './defaultProps';\nimport { getCheckoutDetails } from './services';\nimport './AmazonPay.scss';\nimport { TxVariants } from '../tx-variants';\nimport { sanitizeResponse, verifyPaymentDidNotFail } from '../internal/UIElement/utils';\nimport { ANALYTICS_EXPRESS_PAGES_ARRAY, ANALYTICS_RENDERED_STR } from '../../core/Analytics/constants';\nimport { AnalyticsEvent } from '../../core/Analytics/AnalyticsEvent';\nimport { AnalyticsInfoEvent } from '../../core/Analytics/AnalyticsInfoEvent';\n\nexport class AmazonPayElement extends UIElement<AmazonPayConfiguration> {\n    public static type = TxVariants.amazonpay;\n\n    protected static defaultProps = defaultProps;\n\n    formatProps(props) {\n        return {\n            ...props,\n            checkoutMode: props.isDropin ? 'ProcessOrder' : props.checkoutMode,\n            environment: props.environment.toUpperCase(),\n            locale: props.locale.replace('-', '_'),\n            productType: props.isDropin && !props.addressDetails ? 'PayOnly' : props.productType\n        };\n    }\n\n    /**\n     * Formats the component data output\n     */\n    formatData(): AmazonPayElementData {\n        const { amazonCheckoutSessionId: checkoutSessionId } = this.props;\n        return {\n            paymentMethod: {\n                type: AmazonPayElement.type,\n                ...(checkoutSessionId && { checkoutSessionId })\n            },\n            browserInfo: this.browserInfo\n        };\n    }\n\n    protected submitAnalytics(analyticsObj: AnalyticsEvent) {\n        // Analytics will need to know about this.props.isExpress & this.props.expressPage\n        if (analyticsObj instanceof AnalyticsInfoEvent && analyticsObj.type === ANALYTICS_RENDERED_STR) {\n            const { isExpress, expressPage } = this.props;\n            const hasExpressPage = expressPage && ANALYTICS_EXPRESS_PAGES_ARRAY.includes(expressPage);\n\n            if (typeof isExpress === 'boolean') {\n                analyticsObj.isExpress = isExpress;\n            }\n\n            if (isExpress === true && hasExpressPage) {\n                analyticsObj.expressPage = expressPage; // We only care about the expressPage value if isExpress is true\n            }\n        }\n\n        super.submitAnalytics(analyticsObj);\n    }\n\n    getShopperDetails() {\n        const { amazonCheckoutSessionId, configuration = {}, loadingContext, clientKey } = this.props;\n        if (!amazonCheckoutSessionId) return console.error('Could not shopper details. Missing checkoutSessionId.');\n\n        const request: CheckoutDetailsRequest = {\n            checkoutSessionId: amazonCheckoutSessionId,\n            getDeliveryAddress: true,\n            publicKeyId: configuration.publicKeyId,\n            region: configuration.region\n        };\n\n        return getCheckoutDetails(loadingContext, clientKey, request);\n    }\n\n    public handleDeclineFlow() {\n        const { amazonCheckoutSessionId, configuration = {}, loadingContext, clientKey } = this.props;\n        if (!amazonCheckoutSessionId) return console.error('Could handle the decline flow. Missing checkoutSessionId.');\n\n        const request: CheckoutDetailsRequest = {\n            checkoutSessionId: amazonCheckoutSessionId,\n            getDeclineFlowUrl: true,\n            publicKeyId: configuration.publicKeyId,\n            region: configuration.region\n        };\n\n        getCheckoutDetails(loadingContext, clientKey, request)\n            .then((response = {}) => {\n                if (!response?.declineFlowUrl) throw response;\n                window.location.assign(response.declineFlowUrl);\n            })\n            .catch(error => {\n                if (this.props.onError) this.props.onError(error, this.componentRef);\n            });\n    }\n\n    get isValid() {\n        return true;\n    }\n\n    get browserInfo() {\n        return collectBrowserInfo();\n    }\n\n    public submit(): void {\n        const amazonComponentSubmit = this.componentRef && this.componentRef.getSubmitFunction();\n        if (amazonComponentSubmit) {\n            return amazonComponentSubmit();\n        }\n        this.makePaymentsCall().then(sanitizeResponse).then(verifyPaymentDidNotFail).then(this.handleResponse).catch(this.handleFailedResult);\n    }\n\n    render() {\n        return (\n            <CoreProvider i18n={this.props.i18n} loadingContext={this.props.loadingContext} resources={this.resources}>\n                <AmazonPayComponent\n                    ref={ref => {\n                        this.componentRef = ref;\n                    }}\n                    showPayButton={this.props.showPayButton}\n                    onClick={this.props.onClick}\n                    onError={this.props.onError}\n                    onSignOut={this.props.onSignOut}\n                    {...this.props}\n                />\n            </CoreProvider>\n        );\n    }\n}\n\nexport default AmazonPayElement;\n"],"names":["AmazonPayElement","UIElement","formatProps","props","_object_spread_props","checkoutMode","isDropin","environment","toUpperCase","locale","replace","productType","addressDetails","formatData","amazonCheckoutSessionId","checkoutSessionId","this","paymentMethod","_object_spread","type","browserInfo","submitAnalytics","analyticsObj","AnalyticsInfoEvent","ANALYTICS_RENDERED_STR","isExpress","expressPage","hasExpressPage","ANALYTICS_EXPRESS_PAGES_ARRAY","includes","super","getShopperDetails","configuration","loadingContext","clientKey","console","error","request","getDeliveryAddress","publicKeyId","region","getCheckoutDetails","handleDeclineFlow","getDeclineFlowUrl","then","response","declineFlowUrl","window","location","assign","catch","onError","componentRef","isValid","collectBrowserInfo","submit","amazonComponentSubmit","getSubmitFunction","makePaymentsCall","sanitizeResponse","verifyPaymentDidNotFail","handleResponse","handleFailedResult","render","h","CoreProvider","i18n","resources","AmazonPayComponent","ref","showPayButton","onClick","onSignOut","_define_property","TxVariants","amazonpay","defaultProps"],"mappings":"i/CAeO,MAAMA,UAAyBC,EAKlCC,WAAAA,CAAYC,GACR,OAAOC,EACAD,EAAAA,CAAAA,EAAAA,GAAAA,CACHE,aAAcF,EAAMG,SAAW,eAAiBH,EAAME,aACtDE,YAAaJ,EAAMI,YAAYC,cAC/BC,OAAQN,EAAMM,OAAOC,QAAQ,IAAK,KAClCC,YAAaR,EAAMG,WAAaH,EAAMS,eAAiB,UAAYT,EAAMQ,aAEjF,CAKAE,UAAAA,GACI,MAAQC,wBAAyBC,GAAsBC,KAAKb,MAC5D,MAAO,CACHc,cAAeC,EAAA,CACXC,KAAMnB,EAAiBmB,MACnBJ,GAAqB,CAAEA,sBAE/BK,YAAaJ,KAAKI,YAE1B,CAEUC,eAAAA,CAAgBC,GAEtB,GAAIA,aAAwBC,GAAsBD,EAAaH,OAASK,EAAwB,CAC5F,MAAMC,UAAEA,EAASC,YAAEA,GAAgBV,KAAKb,MAClCwB,EAAiBD,GAAeE,EAA8BC,SAASH,GAEpD,kBAAdD,IACPH,EAAaG,UAAYA,IAGX,IAAdA,GAAsBE,IACtBL,EAAaI,YAAcA,EAEnC,CAEAI,MAAMT,gBAAgBC,EAC1B,CAEAS,iBAAAA,GACI,MAAMjB,wBAAEA,EAAuBkB,cAAEA,EAAgB,CAAA,EAAEC,eAAEA,EAAcC,UAAEA,GAAclB,KAAKb,MACxF,IAAKW,EAAyB,OAAOqB,QAAQC,MAAM,yDAEnD,MAAMC,EAAkC,CACpCtB,kBAAmBD,EACnBwB,oBAAoB,EACpBC,YAAaP,EAAcO,YAC3BC,OAAQR,EAAcQ,QAG1B,OAAOC,EAAmBR,EAAgBC,EAAWG,EACzD,CAEOK,iBAAAA,GACH,MAAM5B,wBAAEA,EAAuBkB,cAAEA,EAAgB,CAAA,EAAEC,eAAEA,EAAcC,UAAEA,GAAclB,KAAKb,MACxF,IAAKW,EAAyB,OAAOqB,QAAQC,MAAM,6DAEnD,MAAMC,EAAkC,CACpCtB,kBAAmBD,EACnB6B,mBAAmB,EACnBJ,YAAaP,EAAcO,YAC3BC,OAAQR,EAAcQ,QAG1BC,EAAmBR,EAAgBC,EAAWG,GACzCO,MAAK,CAACC,EAAW,MACd,KAAKA,aAAAA,EAAAA,EAAUC,gBAAgB,MAAMD,EACrCE,OAAOC,SAASC,OAAOJ,EAASC,eAAc,IAEjDI,OAAMd,IACCpB,KAAKb,MAAMgD,SAASnC,KAAKb,MAAMgD,QAAQf,EAAOpB,KAAKoC,aAAY,GAE/E,CAEA,WAAIC,GACA,OAAO,CACX,CAEA,eAAIjC,GACA,OAAOkC,GACX,CAEOC,MAAAA,GACH,MAAMC,EAAwBxC,KAAKoC,cAAgBpC,KAAKoC,aAAaK,oBACrE,GAAID,EACA,OAAOA,IAEXxC,KAAK0C,mBAAmBd,KAAKe,GAAkBf,KAAKgB,GAAyBhB,KAAK5B,KAAK6C,gBAAgBX,MAAMlC,KAAK8C,mBACtH,CAEAC,MAAAA,GACI,OACIC,EAACC,EAAAA,CAAaC,KAAMlD,KAAKb,MAAM+D,KAAMjC,eAAgBjB,KAAKb,MAAM8B,eAAgBkC,UAAWnD,KAAKmD,WAC5FH,EAACI,EAAAA,EAAAA,CACGC,IAAKA,IACDrD,KAAKoC,aAAeiB,CAAAA,EAExBC,cAAetD,KAAKb,MAAMmE,cAC1BC,QAASvD,KAAKb,MAAMoE,QACpBpB,QAASnC,KAAKb,MAAMgD,QACpBqB,UAAWxD,KAAKb,MAAMqE,WAClBxD,KAAKb,QAIzB,EAhHAsE,EADSzE,EACKmB,OAAOuD,EAAWC,WAEhCF,EAHSzE,EAGQ4E,eAAeA"}