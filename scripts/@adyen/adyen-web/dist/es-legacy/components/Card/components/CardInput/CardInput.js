import{createElement as e,Fragment as r}from"../../../../external/preact/dist/preact.js";import{useRef as t,useMemo as o,useState as n,useCallback as s,useEffect as a}from"../../../../external/preact/hooks/dist/hooks.js";import i from"../../../internal/SecuredFields/SFP/SecuredFieldsProvider.js";import l from"./defaultProps.js";import{AddressModeOptions as d}from"./types.js";import{DATE_POLICY_REQUIRED as u,CVC_POLICY_REQUIRED as c,ENCRYPTED_CARD_NUMBER as m}from"../../../internal/SecuredFields/lib/constants.js";import{cardInputValidationRules as p,cardInputFormatters as f,getRuleByNameAndMode as b}from"./validate.js";import y from"../../../internal/SecuredFields/binLookup/extensions.js";import h from"../../../../utils/useForm/useForm.js";import{handlePartialAddressMode as g,extractPropsForSFP as S,getLayout as N,extractPropsForCardFields as A}from"./utils.js";import j from"../../../internal/Address/Specifications.js";import{StoredCardFieldsWrapper as v}from"./components/StoredCardFieldsWrapper.js";import{CardFieldsWrapper as F}from"./components/CardFieldsWrapper.js";import{getAutoJumpHandler as O,getFocusHandler as C,getAddressHandler as w}from"./handlers.js";import P from"../../../../_virtual/index.js";import{getPartialAddressValidationRules as k}from"../../../internal/Address/validate.js";import E from"../../../../core/Context/useImage.js";import{getArrayDifferences as R}from"../../../../utils/arrayUtils.js";import x from"../../../internal/FormInstruction/FormInstruction.js";import{PREFIX as B}from"../../../internal/Icon/constants.js";import I from"./useSRPanelForCardInputErrors.js";import V from"../Fastlane/FastlaneSignup.js";import{ANALYTICS_VALIDATION_ERROR_STR as D,ANALYTICS_DISPLAYED_STR as q,ANALYTICS_SELECTED_STR as M}from"../../../../core/Analytics/constants.js";import{fieldTypeToSnakeCase as _}from"../../../internal/SecuredFields/utils.js";import{getErrorMessageFromCode as L}from"../../../../core/Errors/utils.js";import{SF_ErrorCodes as T}from"../../../../core/Errors/constants.js";import{usePrevious as K}from"../../../../utils/hookUtils.js";import{AnalyticsInfoEvent as U}from"../../../../core/Analytics/AnalyticsInfoEvent.js";function H(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function z(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{},o=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),o.forEach((function(r){H(e,r,t[r])}))}return e}function W(e,r){return r=null!=r?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):function(e){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r.push.apply(r,t)}return r}(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})),e}const $="dual_brand_button",G=l=>{var H,G;const J=t(null),Q=t(!1),X=E(),Y=t(null),Z=e=>{Y.current=e},ee=t({});Object.keys(ee.current).length||l.setComponentRef(ee.current);const re=t(0),te=t(!1),oe=o((()=>new j(l.specifications)),[l.specifications]);ee.current.sfp=J;const[ne,se]=n("ready"),[ae,ie]=n({}),[le,de]=n(z({},l.holderNameRequired&&{holderName:!1}));var ue;const[ce,me]=n(z({},l.hasHolderName&&{holderName:null!==(ue=l.data.holderName)&&void 0!==ue?ue:""})),[pe,fe]=n(""),[be,ye]=n(!1),[he,ge]=n(u),[Se,Ne]=n(c),[Ae,je]=n(null),[ve,Fe]=n([]),[Oe,Ce]=n(l.storedPaymentMethodId?l.brand:""),we=l.billingAddressMode!==d.none&&l.billingAddressRequired,Pe=g(l.billingAddressMode),ke=t(Pe&&(null===(G=l.data)||void 0===G||null===(H=G.billingAddress)||void 0===H?void 0:H.country)),[Ee,Re]=n(!1),[xe,Be]=n(we?l.data.billingAddress:null),[Ie,Ve]=n(!1),[De,qe]=n(""),[Me,_e]=n({value:null}),[Le,Te]=n(null),[Ke,Ue]=n("card"),[He,ze]=n(!1),{handleChangeFor:We,triggerValidation:$e,data:Ge,valid:Je,errors:Qe,setSchema:Xe,setData:Ye,setValid:Ze,setErrors:er}=h({schema:[],defaultData:l.data,formatters:f,rules:p}),rr=!!Object.keys(l.installmentOptions).length&&"debit"!==l.fundingSource;var tr;const or=null===(tr=l.showInstallmentAmounts)||void 0===tr||tr,nr="kr"===(null!=Ae?Ae:l.countryCode),sr=l.configuration.koreanAuthenticationRequired&&nr,ar=Ie&&"auto"===l.configuration.socialSecurityNumberMode||"show"===l.configuration.socialSecurityNumberMode,ir=(e,r)=>{l.onFocus({fieldType:e,event:r})},lr=(e,r)=>{l.onBlur({fieldType:e,event:r})},dr=s((e=>{Ue(e.brand),l.onBrand(e)}),[]),ur=C(fe,ir,lr),cr=()=>N(z({props:l,showKCP:sr,showBrazilianSSN:ar},l.billingAddressRequired&&{countrySpecificSchemas:oe.getAddressSchemaForCountry(null==xe?void 0:xe.country),billingAddressRequiredFields:l.billingAddressRequiredFields})),mr=s((e=>{const r="webInternalElement"!==e.fieldType?e.fieldType:e.name;Te(r)}),[]),pr=w(Ye,Ze,er),fr=O(te,J,cr()),br=s((e=>{yr(e)}),[He,ze]),yr=e=>{e.status&&("loading"==e.status?ze(!1):ze(!0))},hr=o((()=>y(l,{sfp:J},{dualBrandSelectElements:ve,setDualBrandSelectElements:Fe,setSelectedBrandValue:Ce,issuingCountryCode:Ae,setIssuingCountryCode:je},re)),[ve,Ae]);ee.current.showValidation=()=>{Q.current=!0,null==Nr||Nr(),J.current.showValidation(),$e(["holderName","socialSecurityNumber","taxNumber"]),(null==Y?void 0:Y.current)&&Y.current.showValidation()},ee.current.processBinLookupResponse=(e,r)=>{hr.processBinLookup(e,r)},ee.current.setStatus=se,a((()=>(ee.current.setFocusOn=J.current.setFocusOn,ee.current.updateStyles=J.current.updateStyles,ee.current.handleUnsupportedCard=J.current.handleUnsupportedCard,()=>{J.current.destroy()})),[]),a((()=>{const e=[...l.hasHolderName?["holderName"]:[],...ar?["socialSecurityNumber"]:[],...sr?["taxNumber"]:[],...we?["billingAddress"]:[]];Xe(e)}),[l.hasHolderName,ar,sr]),a((()=>{var e;me(W(z({},ce),{holderName:null!==(e=Ge.holderName)&&void 0!==e?e:"",taxNumber:Ge.taxNumber})),qe(Ge.socialSecurityNumber),we&&Be(z({},Ge.billingAddress)),de(W(z({},le),{holderName:!l.holderNameRequired||Je.holderName,socialSecurityNumber:!!Je.socialSecurityNumber&&Je.socialSecurityNumber,taxNumber:!!Je.taxNumber&&Je.taxNumber,billingAddress:!!Je.billingAddress&&Je.billingAddress}));const r=!!Qe.billingAddress&&Object.entries(Qe.billingAddress).reduce(((e,[,r])=>e||null!=r),!1);ie(W(z({},ae),{holderName:l.holderNameRequired&&Qe.holderName?Qe.holderName:null,socialSecurityNumber:ar&&Qe.socialSecurityNumber?Qe.socialSecurityNumber:null,taxNumber:sr&&Qe.taxNumber?Qe.taxNumber:null,billingAddress:we&&r?Qe.billingAddress:null}))}),[Ge,Je,Qe]);const{sortedErrorList:gr,previousSortedErrors:Sr,clearSRPanel:Nr}=I({errors:ae,props:l,isValidating:Q,retrieveLayout:cr,specifications:oe,billingAddress:xe,sfp:J});a((()=>{if(gr){const e=R(gr,Sr,"field");null==e||e.forEach((e=>{const r=new U({type:D,target:_(e.field),validationErrorCode:e.errorCode,validationErrorMessage:L(e.errorCode,T)});l.onSubmitAnalytics(r)}))}}),[gr]),a((()=>{const e=le.holderName,r=be,t=!we||le.billingAddress,o=!sr||!!le.taxNumber&&!!le.encryptedPassword,n=!ar||!!le.socialSecurityNumber,s=r&&e&&t&&o&&n,a=J.current.mapErrorsToValidationRuleResult(),i=z({},ae,a);l.onChange({data:ce,valid:le,errors:i,isValid:s,billingAddress:xe,selectedBrandValue:Oe,storePaymentMethod:Ee,socialSecurityNumber:De,installments:Me})}),[ce,le,ae,Oe,Ee,Me]),a((()=>{if(ve.length>0&&ve){const e=ve.map((e=>e.id)),r=e[0],t=e.toString(),o=new U({type:q,target:$,brand:r,configData:{dualBrands:t}});l.onSubmitAnalytics(o)}}),[ve]);const Ar=K(Oe);a((()=>{if((null==Ar?void 0:Ar.length)&&(null==Oe?void 0:Oe.length)){const e=new U({type:M,target:$,brand:Oe});l.onSubmitAnalytics(e)}}),[Oe]);const jr=l.storedPaymentMethodId?v:F;return e(r,null,e(i,W(z({ref:J},S(l)),{styles:z({},l.styles),koreanAuthenticationRequired:l.configuration.koreanAuthenticationRequired,hasKoreanFields:!(!l.configuration.koreanAuthenticationRequired||"kr"!==l.countryCode),onChange:(e,r)=>{if(e.autoCompleteName){if(!l.hasHolderName)return;const r=b("holderName","blur")(e.autoCompleteName)?e.autoCompleteName:null;r&&(Ye("holderName",r),Ze("holderName",!0),er("holderName",null))}else l.autoFocus&&re.current>0&&"handleOnFieldValid"===(null==r?void 0:r.event)&&(null==r?void 0:r.fieldType)===m&&e.valid.encryptedCardNumber&&fr(),me(z({},ce,e.data)),ie(z({},ae,e.errors)),de(z({},le,e.valid)),ye(e.isSfpValid),Ne(e.cvcPolicy),Ve(e.showSocialSecurityNumber),ge(e.expiryDatePolicy)},onBrand:dr,onFocus:ur,onStateUpdate:br,type:l.brand,disableIOSArrowKeys:l.disableIOSArrowKeys?mr:null,render:({setRootNode:r,setFocusOn:t},o)=>{var n;return e("div",{ref:r,className:P({"adyen-checkout__card-input":!0,"adyen-checkout-card-input__wrapper":!0,[`adyen-checkout__card-input--${null!==(n=l.fundingSource)&&void 0!==n?n:"credit"}`]:!0,"adyen-checkout__card-input--loading":"loading"===ne}),role:"form"},He&&e(x,null),e(jr,W(z({},A(l)),{data:ce,valid:le,errors:ae,handleChangeFor:We,focusedElement:pe,setFocusOn:t,sfpState:o,cvcPolicy:Se,hasInstallments:rr,showAmountsInInstallments:or,handleInstallments:_e,brandsIcons:l.brandsIcons,formData:Ge,formErrors:Qe,formValid:Je,expiryDatePolicy:he,dualBrandSelectElements:ve,extensions:hr,selectedBrandValue:Oe,showKCP:sr,showBrazilianSSN:ar,socialSecurityNumber:De,handleOnStoreDetails:Re,setAddressRef:Z,billingAddress:xe,billingAddressValidationRules:Pe&&k(ke.current),partialAddressSchema:Pe,handleAddress:pr,onAddressLookup:l.onAddressLookup,onAddressSelected:l.onAddressSelected,addressSearchDebounceMs:l.addressSearchDebounceMs,iOSFocusedField:Le,onFieldFocusAnalytics:ir,onFieldBlurAnalytics:lr})))}})),l.fastlaneConfiguration&&e(V,W(z({},l.fastlaneConfiguration),{currentDetectedBrand:Ke,onChange:l.onChange,onSubmitAnalytics:l.onSubmitAnalytics})),He&&l.showPayButton&&l.payButton({status:ne,variant:l.isPayButtonPrimaryVariant?"primary":"secondary",icon:X({imageFolder:"components/"})(`${B}lock`)}))};G.defaultProps=l;export{G as default};
//# sourceMappingURL=CardInput.js.map
