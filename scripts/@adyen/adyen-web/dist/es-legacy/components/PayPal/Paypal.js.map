{"version":3,"file":"Paypal.js","sources":["../../../../src/components/PayPal/Paypal.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport PaypalComponent from './components/PaypalComponent';\nimport defaultProps from './defaultProps';\nimport { CoreProvider } from '../../core/Context/CoreProvider';\nimport AdyenCheckoutError from '../../core/Errors/AdyenCheckoutError';\nimport { ERRORS } from './constants';\nimport { TxVariants } from '../tx-variants';\nimport { formatPaypalOrderContactToAdyenFormat } from './utils/format-paypal-order-contact-to-adyen-format';\n\nimport type { ICore } from '../../core/types';\nimport type { PaymentAction } from '../../types/global-types';\nimport type { Intent, PayPalConfiguration } from './types';\n\nimport './Paypal.scss';\nimport { ANALYTICS_EXPRESS_PAGES_ARRAY, ANALYTICS_RENDERED_STR } from '../../core/Analytics/constants';\nimport { AnalyticsInfoEvent } from '../../core/Analytics/AnalyticsInfoEvent';\nimport { AnalyticsEvent } from '../../core/Analytics/AnalyticsEvent';\n\nclass PaypalElement extends UIElement<PayPalConfiguration> {\n    public static type = TxVariants.paypal;\n    public static subtype = 'sdk';\n\n    public paymentData: string = null;\n\n    private resolve = null;\n    private reject = null;\n\n    protected static defaultProps = defaultProps;\n\n    constructor(checkout: ICore, props?: PayPalConfiguration) {\n        super(checkout, props);\n        this.handleSubmit = this.handleSubmit.bind(this);\n        this.handleOnShippingAddressChange = this.handleOnShippingAddressChange.bind(this);\n        this.handleOnShippingOptionsChange = this.handleOnShippingOptionsChange.bind(this);\n    }\n\n    formatProps(props: PayPalConfiguration): PayPalConfiguration {\n        const merchantId = props.configuration?.merchantId;\n        const intentFromConfig = props.configuration?.intent;\n        const isZeroAuth = props.amount?.value === 0;\n        const intent: Intent = isZeroAuth ? 'tokenize' : props.intent || intentFromConfig;\n        const vault = intent === 'tokenize' || props.vault;\n\n        const displayContinueToReviewPageButton = props.userAction === 'continue';\n\n        return {\n            ...props,\n            commit: displayContinueToReviewPageButton ? false : props.commit,\n            vault,\n            configuration: {\n                intent,\n                merchantId\n            }\n        };\n    }\n\n    protected submitAnalytics(analyticsObj: AnalyticsEvent) {\n        // Analytics will need to know about this.props.isExpress & this.props.expressPage\n        if (analyticsObj instanceof AnalyticsInfoEvent && analyticsObj.type === ANALYTICS_RENDERED_STR) {\n            const { isExpress, expressPage } = this.props;\n            const hasExpressPage = expressPage && ANALYTICS_EXPRESS_PAGES_ARRAY.includes(expressPage);\n\n            if (typeof isExpress === 'boolean') {\n                analyticsObj.isExpress = isExpress;\n            }\n\n            if (isExpress === true && hasExpressPage) {\n                analyticsObj.expressPage = expressPage; // We only care about the expressPage value if isExpress is true\n            }\n        }\n\n        super.submitAnalytics(analyticsObj);\n    }\n\n    public submit = () => {\n        this.handleError(new AdyenCheckoutError('IMPLEMENTATION_ERROR', ERRORS.SUBMIT_NOT_SUPPORTED));\n    };\n\n    /**\n     * Updates the paymentData value. It must be used in the PayPal Express flow, when patching the amount\n     * @param paymentData - Payment data value\n     */\n    public updatePaymentData(paymentData: string): void {\n        if (!paymentData) console.warn('PayPal - Updating payment data with an invalid value');\n        this.paymentData = paymentData;\n    }\n\n    /**\n     * Formats the component data output\n     */\n    protected formatData() {\n        const { isExpress, userAction } = this.props;\n\n        return {\n            paymentMethod: {\n                type: PaypalElement.type,\n                userAction,\n                subtype: isExpress ? 'express' : PaypalElement.subtype\n            }\n        };\n    }\n\n    public handleAction = (action: PaymentAction) => {\n        return this.updateWithAction(action);\n    };\n\n    public updateWithAction = (action: PaymentAction) => {\n        if (action.paymentMethodType !== this.type) throw new Error('Invalid Action');\n\n        if (action.paymentData) {\n            this.paymentData = action.paymentData;\n        }\n\n        if (action.sdkData && action.sdkData.token) {\n            this.onActionHandled({ componentType: this.type, actionDescription: 'sdk-loaded', originalAction: action });\n            this.handleResolve(action.sdkData.token);\n        } else {\n            this.handleReject(ERRORS.NO_TOKEN_PROVIDED);\n        }\n\n        return null;\n    };\n\n    /**\n     * Dropin Validation\n     *\n     * @remarks\n     * Paypal does not require any specific Dropin validation\n     */\n    get isValid() {\n        return true;\n    }\n\n    private handleOnApprove = (data: any, actions: any): Promise<void> | void => {\n        const { onAuthorized } = this.props;\n        const state = { data: { details: data, paymentData: this.paymentData } };\n\n        if (!onAuthorized) {\n            this.handleAdditionalDetails(state);\n            return;\n        }\n\n        return actions.order\n            .get()\n            .then((paypalOrder: any) => {\n                const billingAddress = formatPaypalOrderContactToAdyenFormat(paypalOrder?.payer);\n                const deliveryAddress = formatPaypalOrderContactToAdyenFormat(paypalOrder?.purchase_units?.[0].shipping, true);\n\n                this.setState({\n                    authorizedEvent: paypalOrder,\n                    ...(billingAddress && { billingAddress }),\n                    ...(deliveryAddress && { deliveryAddress })\n                });\n\n                return new Promise<void>((resolve, reject) =>\n                    onAuthorized(\n                        {\n                            authorizedEvent: paypalOrder,\n                            ...(billingAddress && { billingAddress }),\n                            ...(deliveryAddress && { deliveryAddress })\n                        },\n                        { resolve, reject }\n                    )\n                );\n            })\n            .then(() => this.handleAdditionalDetails(state))\n            .catch(error => this.handleError(new AdyenCheckoutError('ERROR', 'Something went wrong while parsing PayPal Order', { cause: error })));\n    };\n\n    handleResolve(token: string) {\n        if (!this.resolve) return this.handleError(new AdyenCheckoutError('ERROR', ERRORS.WRONG_INSTANCE));\n        this.resolve(token);\n    }\n\n    handleReject(errorMessage: string) {\n        if (!this.reject) return this.handleError(new AdyenCheckoutError('ERROR', ERRORS.WRONG_INSTANCE));\n        this.reject(new Error(errorMessage));\n    }\n\n    private handleSubmit(): Promise<void> {\n        super.submit();\n\n        return new Promise((resolve, reject) => {\n            this.resolve = resolve;\n            this.reject = reject;\n        });\n    }\n\n    /**\n     * If the merchant provides the 'onShippingAddressChange' callback, then this method is used as a wrapper to it, in order\n     * to expose to the merchant the 'component' instance. The merchant needs the 'component' in order to manipulate the\n     * paymentData\n     *\n     * @param data - PayPal data\n     * @param actions - PayPal actions.\n     */\n    private handleOnShippingAddressChange(data: any, actions: any): Promise<void> {\n        return this.props.onShippingAddressChange(data, actions, this);\n    }\n\n    /**\n     * If the merchant provides the 'onShippingOptionsChange' callback, then this method is used as a wrapper to it, in order\n     * to expose to the merchant the 'component' instance. The merchant needs the 'component' in order to manipulate the\n     * paymentData\n     *\n     * @param data - PayPal data\n     * @param actions - PayPal actions.\n     */\n    private handleOnShippingOptionsChange(data: any, actions: any): Promise<void> {\n        return this.props.onShippingOptionsChange(data, actions, this);\n    }\n\n    render() {\n        if (!this.props.showPayButton) return null;\n\n        const { onShippingAddressChange, onShippingOptionsChange, ...rest } = this.props;\n\n        return (\n            <CoreProvider i18n={this.props.i18n} loadingContext={this.props.loadingContext} resources={this.resources}>\n                <PaypalComponent\n                    ref={ref => {\n                        this.componentRef = ref;\n                    }}\n                    {...rest}\n                    {...(onShippingAddressChange && { onShippingAddressChange: this.handleOnShippingAddressChange })}\n                    {...(onShippingOptionsChange && { onShippingOptionsChange: this.handleOnShippingOptionsChange })}\n                    onCancel={() => this.handleError(new AdyenCheckoutError('CANCEL'))}\n                    onChange={this.setState}\n                    onApprove={this.handleOnApprove}\n                    onError={error => {\n                        this.handleError(new AdyenCheckoutError('ERROR', error.toString(), { cause: error }));\n                    }}\n                    onScriptLoadFailure={error => this.handleError(error)}\n                    onSubmit={this.handleSubmit}\n                />\n            </CoreProvider>\n        );\n    }\n}\n\nexport default PaypalElement;\n"],"names":["PaypalElement","UIElement","formatProps","props","merchantId","configuration","intentFromConfig","intent","amount","value","vault","displayContinueToReviewPageButton","userAction","_object_spread_props","commit","submitAnalytics","analyticsObj","AnalyticsInfoEvent","type","ANALYTICS_RENDERED_STR","isExpress","expressPage","this","hasExpressPage","ANALYTICS_EXPRESS_PAGES_ARRAY","includes","super","updatePaymentData","paymentData","console","warn","formatData","paymentMethod","subtype","isValid","handleResolve","token","resolve","handleError","AdyenCheckoutError","ERRORS","WRONG_INSTANCE","handleReject","errorMessage","reject","Error","handleSubmit","submit","Promise","handleOnShippingAddressChange","data","actions","onShippingAddressChange","handleOnShippingOptionsChange","onShippingOptionsChange","render","showPayButton","_this_props","rest","_object_without_properties","h","CoreProvider","i18n","loadingContext","resources","PaypalComponent","ref","componentRef","onCancel","onChange","setState","onApprove","handleOnApprove","onError","error","toString","cause","onScriptLoadFailure","onSubmit","constructor","checkout","_define_property","SUBMIT_NOT_SUPPORTED","handleAction","action","updateWithAction","paymentMethodType","sdkData","onActionHandled","componentType","actionDescription","originalAction","NO_TOKEN_PROVIDED","onAuthorized","state","details","order","get","then","paypalOrder","billingAddress","formatPaypalOrderContactToAdyenFormat","payer","deliveryAddress","purchase_units","shipping","_object_spread","authorizedEvent","handleAdditionalDetails","catch","bind","TxVariants","paypal","defaultProps"],"mappings":"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"}