{"version":3,"file":"QRLoader.js","sources":["../../../../../src/components/internal/QRLoader/QRLoader.tsx"],"sourcesContent":["import { Component, h } from 'preact';\nimport Countdown from '../Countdown';\nimport Button from '../Button';\nimport Spinner from '../Spinner';\nimport checkPaymentStatus from '../../../core/Services/payment-status';\nimport processResponse from '../../../core/ProcessResponse';\n\nimport './QRLoader.scss';\nimport { QRLoaderProps, QRLoaderState } from './types';\nimport copyToClipboard from '../../../utils/clipboard';\nimport AdyenCheckoutError from '../../../core/Errors/AdyenCheckoutError';\nimport { useCoreContext } from '../../../core/Context/CoreProvider';\nimport ContentSeparator from '../ContentSeparator';\nimport { StatusObject } from '../Await/types';\nimport useImage from '../../../core/Context/useImage';\nimport { useA11yReporter } from '../../../core/Errors/useA11yReporter';\nimport useAutoFocus from '../../../utils/useAutoFocus';\nimport { ANALYTICS_DOWNLOAD_STR, ANALYTICS_QR_CODE_DOWNLOAD } from '../../../core/Analytics/constants';\nimport { PREFIX } from '../Icon/constants';\nimport { AnalyticsInfoEvent } from '../../../core/Analytics/AnalyticsInfoEvent';\n\nconst QRCODE_URL = 'utility/v1/barcode.png?type=qrCode&data=';\n\nclass QRLoader extends Component<QRLoaderProps, QRLoaderState> {\n    private timeoutId;\n\n    constructor(props) {\n        super(props);\n\n        this.state = {\n            buttonStatus: 'default',\n            completed: false,\n            delay: props.delay,\n            expired: false,\n            loading: true,\n            percentage: 100,\n            timePassed: 0\n        };\n    }\n\n    public static defaultProps = {\n        delay: 2000,\n        countdownTime: 15,\n        onError: () => {},\n        onComplete: () => {},\n        throttleTime: 60000,\n        classNameModifiers: [],\n        throttledInterval: 10000,\n        introduction: 'wechatpay.scanqrcode',\n        timeToPay: 'wechatpay.timetopay',\n        buttonLabel: 'openApp'\n    };\n\n    componentDidMount() {\n        this.statusInterval();\n    }\n\n    componentWillUnmount() {\n        clearTimeout(this.timeoutId);\n    }\n\n    public redirectToApp = (url: string | URL) => {\n        window.location.assign(url);\n    };\n\n    // Retry until getting a complete response from the server, or it times out\n    public statusInterval = (responseTime = 0) => {\n        // If we are already in the final statuses, do not poll!\n        if (this.state.expired || this.state.completed) return;\n\n        this.setState(previous => ({ timePassed: previous.timePassed + this.props.delay + responseTime }));\n        // Changes interval time to 10 seconds after 1 minute (60 seconds)\n        const newDelay = this.state.timePassed >= this.props.throttleTime ? this.props.throttledInterval : this.state.delay;\n        this.pollStatus(newDelay);\n    };\n\n    private pollStatus(delay: number) {\n        clearTimeout(this.timeoutId);\n\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        this.timeoutId = setTimeout(async () => {\n            // Wait for previous status call to finish.\n            // Also taking the server response time into the consideration to calculate timePassed.\n            const start = performance.now();\n            await this.checkStatus();\n            const end = performance.now();\n            this.statusInterval(Math.round(end - start));\n        }, delay);\n    }\n\n    private onTick = (time): void => {\n        this.setState({ percentage: time.percentage });\n    };\n\n    private onTimeUp = (): void => {\n        this.setState({ expired: true });\n        clearTimeout(this.timeoutId);\n        this.props.onError(new AdyenCheckoutError('ERROR', 'Payment Expired'));\n    };\n\n    private onComplete = (status: StatusObject): void => {\n        clearTimeout(this.timeoutId);\n        this.setState({ completed: true, loading: false });\n\n        const state = {\n            data: {\n                details: { payload: status.props.payload },\n                paymentData: this.props.paymentData\n            }\n        };\n\n        this.props.onComplete(state, this);\n    };\n\n    private onError = (status: StatusObject): void => {\n        clearTimeout(this.timeoutId);\n        this.setState({ expired: true, loading: false });\n\n        if (status.props.payload) {\n            const state = {\n                data: {\n                    details: { payload: status.props.payload },\n                    paymentData: this.props.paymentData\n                }\n            };\n            this.props.onComplete(state, this);\n        }\n\n        const error = new AdyenCheckoutError('ERROR', 'error result with no payload in response');\n        return this.props.onError(error);\n    };\n\n    private checkStatus = () => {\n        const { paymentData, clientKey, loadingContext, throttledInterval } = this.props;\n\n        return checkPaymentStatus(paymentData, clientKey, loadingContext, throttledInterval)\n            .then(processResponse)\n            .catch(response => ({ type: 'network-error', props: response }))\n            .then((status: StatusObject) => {\n                switch (status.type) {\n                    case 'success':\n                        this.onComplete(status);\n                        break;\n                    case 'error':\n                        this.onError(status);\n                        break;\n                    default:\n                        this.setState({ loading: false });\n                }\n                return status;\n            });\n    };\n\n    render({ amount, url, brandLogo, brandName, countdownTime, type, onActionHandled }: QRLoaderProps, { expired, completed, loading }) {\n        const { i18n, loadingContext } = useCoreContext();\n        const getImage = useImage();\n\n        const qrCodeImage = this.props.qrCodeData\n            ? `${loadingContext}${QRCODE_URL}${this.props.qrCodeData}&clientKey=${this.props.clientKey}`\n            : this.props.qrCodeImage;\n\n        const finalState = (image, message) => {\n            const status = i18n.get(message);\n            useA11yReporter(status);\n            return (\n                <div className=\"adyen-checkout__qr-loader adyen-checkout__qr-loader--result\">\n                    <img\n                        className=\"adyen-checkout__qr-loader__icon adyen-checkout__qr-loader__icon--result\"\n                        src={getImage({ imageFolder: 'components/' })(image)}\n                        alt={status}\n                    />\n                    <div className=\"adyen-checkout__qr-loader__subtitle\">{status}</div>\n                </div>\n            );\n        };\n\n        if (expired) {\n            return finalState('error', 'error.subtitle.payment');\n        }\n\n        if (completed) {\n            return finalState('success', 'creditCard.success');\n        }\n\n        if (loading) {\n            return (\n                <div className=\"adyen-checkout__qr-loader\">\n                    {brandLogo && (\n                        <div className=\"adyen-checkout__qr-loader__brand-logo-wrapper\">\n                            <img alt={brandName} src={brandLogo} className=\"adyen-checkout__qr-loader__brand-logo\" />\n                        </div>\n                    )}\n                    <Spinner />\n                </div>\n            );\n        }\n\n        const timeToPayString = i18n.get(this.props.timeToPay).split('%@');\n\n        const qrSubtitleRef = useAutoFocus();\n        const classnames = this.props.classNameModifiers.map(m => `adyen-checkout__qr-loader--${m}`);\n\n        return (\n            <div className={`adyen-checkout__qr-loader adyen-checkout__qr-loader--${type} ${classnames.join(' ')}`}>\n                {brandLogo && (\n                    <div className=\"adyen-checkout__qr-loader__brand-logo-wrapper\">\n                        <img src={brandLogo} alt={brandName} className=\"adyen-checkout__qr-loader__brand-logo\" />\n                    </div>\n                )}\n\n                {amount && amount.value && amount.currency && (\n                    <div className=\"adyen-checkout__qr-loader__payment_amount\">{i18n.amount(amount.value, amount.currency)}</div>\n                )}\n\n                {url && (\n                    <div className=\"adyen-checkout__qr-loader__app-link\">\n                        {this.props.redirectIntroduction && (\n                            <div className=\"adyen-checkout__qr-loader__subtitle\">{i18n.get(this.props.redirectIntroduction)}</div>\n                        )}\n                        <Button classNameModifiers={['qr-loader']} onClick={() => this.redirectToApp(url)} label={i18n.get(this.props.buttonLabel)} />\n                        <ContentSeparator />\n                    </div>\n                )}\n\n                {/* eslint-disable-next-line jsx-a11y/no-noninteractive-tabindex */}\n                <div ref={qrSubtitleRef} tabIndex={0} className=\"adyen-checkout__qr-loader__subtitle\">\n                    {typeof this.props.introduction === 'string' ? i18n.get(this.props.introduction) : this.props.introduction?.()}\n                </div>\n\n                <img\n                    src={qrCodeImage}\n                    alt={i18n.get('wechatpay.scanqrcode')}\n                    onLoad={() => {\n                        onActionHandled?.({\n                            componentType: this.props.type,\n                            actionDescription: 'qr-code-loaded'\n                        });\n                    }}\n                />\n\n                <div className=\"adyen-checkout__qr-loader__progress\">\n                    <span className=\"adyen-checkout__qr-loader__percentage\" style={{ width: `${this.state.percentage}%` }} />\n                </div>\n\n                <div className=\"adyen-checkout__qr-loader__countdown\">\n                    {timeToPayString[0]}&nbsp;\n                    <Countdown minutesFromNow={countdownTime} onTick={this.onTick} onCompleted={this.onTimeUp} />\n                    &nbsp;{timeToPayString[1]}\n                </div>\n\n                {this.props.instructions && (\n                    <div className=\"adyen-checkout__qr-loader__instructions\">\n                        {typeof this.props.instructions === 'string' ? i18n.get(this.props.instructions) : this.props.instructions?.()}\n                    </div>\n                )}\n\n                {this.props.copyBtn && (\n                    <div className=\"adyen-checkout__qr-loader__actions\">\n                        <Button\n                            inline\n                            variant=\"action\"\n                            onClick={(e, { complete }) => {\n                                copyToClipboard(this.props.qrCodeData);\n\n                                const event = new AnalyticsInfoEvent({\n                                    type: ANALYTICS_DOWNLOAD_STR,\n                                    target: ANALYTICS_QR_CODE_DOWNLOAD\n                                });\n                                this.props.onSubmitAnalytics(event);\n\n                                complete();\n                            }}\n                            icon={getImage({ imageFolder: 'components/' })(`${PREFIX}copy`)}\n                            label={i18n.get('button.copy')}\n                        />\n                    </div>\n                )}\n            </div>\n        );\n    }\n}\n\nexport default QRLoader;\n"],"names":["QRLoader","Component","componentDidMount","this","statusInterval","componentWillUnmount","clearTimeout","timeoutId","pollStatus","delay","setTimeout","async","start","performance","now","checkStatus","end","Math","round","render","amount","url","brandLogo","brandName","countdownTime","type","onActionHandled","expired","completed","loading","_this_props_introduction","_this_props","_this_props_instructions","_this_props1","i18n","loadingContext","useCoreContext","getImage","useImage","qrCodeImage","props","qrCodeData","clientKey","finalState","image","message","status","get","useA11yReporter","h","div","className","img","src","imageFolder","alt","Spinner","timeToPayString","timeToPay","split","qrSubtitleRef","useAutoFocus","classnames","classNameModifiers","map","m","join","value","currency","redirectIntroduction","Button","onClick","redirectToApp","label","buttonLabel","ContentSeparator","ref","tabIndex","introduction","call","onLoad","componentType","actionDescription","span","style","width","state","percentage","Countdown","minutesFromNow","onTick","onCompleted","onTimeUp","instructions","copyBtn","inline","variant","e","complete","copyToClipboard","event","AnalyticsInfoEvent","ANALYTICS_DOWNLOAD_STR","target","ANALYTICS_QR_CODE_DOWNLOAD","onSubmitAnalytics","icon","PREFIX","constructor","super","_define_property","window","location","assign","responseTime","setState","previous","timePassed","newDelay","throttleTime","throttledInterval","time","onError","AdyenCheckoutError","onComplete","data","details","payload","paymentData","error","checkPaymentStatus","then","processResponse","catch","response","buttonStatus","defaultProps"],"mappings":"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"}