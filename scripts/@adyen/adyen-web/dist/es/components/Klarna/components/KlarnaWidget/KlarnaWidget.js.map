{"version":3,"file":"KlarnaWidget.js","sources":["../../../../../../src/components/Klarna/components/KlarnaWidget/KlarnaWidget.tsx"],"sourcesContent":["import { h } from 'preact';\nimport { useEffect, useRef, useState, useCallback } from 'preact/hooks';\nimport Script from '../../../../utils/Script';\nimport { KLARNA_WIDGET_URL } from '../../constants';\nimport type { KlarnaWidgetAuthorizeResponse, KlarnaWidgetProps } from '../../types';\n\nimport './KlarnaWidget.scss';\n\nexport function KlarnaWidget({ sdkData, paymentMethodType, widgetInitializationTime, payButton, ...props }: KlarnaWidgetProps) {\n    const klarnaWidgetRef = useRef(null);\n    const [status, setStatus] = useState('ready');\n\n    const handleError = useCallback(() => {\n        setStatus('error');\n        props.onComplete({\n            data: {\n                paymentData: props.paymentData,\n                details: {}\n            }\n        });\n    }, [props.paymentData, props.onComplete]);\n\n    const initializeKlarnaWidget = useCallback(() => {\n        window.Klarna.Payments.init({\n            client_token: sdkData.client_token\n        });\n\n        window.Klarna.Payments.load(\n            {\n                container: klarnaWidgetRef.current,\n                payment_method_category: sdkData.payment_method_category\n            },\n            function (res) {\n                // If show_form: true is received together with an error, something fixable is wrong and the consumer\n                // needs to take action before moving forward\n                // If show_form: false, the payment method in the loaded widget will not be offered for this order\n                // based on Klarnaâ€™s pre-assessment.\n                if (!res.show_form || !!res.error) {\n                    handleError();\n                } else {\n                    props.onLoaded();\n                }\n            }\n        );\n    }, [sdkData.client_token, sdkData.payment_method_category]);\n\n    const authorizeKlarna = useCallback(() => {\n        setStatus('loading');\n        try {\n            window.Klarna.Payments.authorize(\n                {\n                    payment_method_category: sdkData.payment_method_category\n                },\n                function (res: KlarnaWidgetAuthorizeResponse) {\n                    if (res.approved === true && res.show_form === true) {\n                        // Klarna has approved the authorization of credit for this order.\n                        setStatus('success');\n                        props.onComplete({\n                            data: {\n                                paymentData: props.paymentData,\n                                details: {\n                                    authorization_token: res.authorization_token\n                                }\n                            }\n                        });\n                    } else if (!res.approved && res.show_form === true) {\n                        // Fixable error\n                        setStatus('ready');\n                        props.onError(res);\n                    } else {\n                        // The purchase is declined. The widget should be hidden and the user\n                        // should select another payment method.\n                        handleError();\n                    }\n                }\n            );\n        } catch (e) {\n            handleError();\n        }\n    }, [sdkData.payment_method_category, props.onComplete, props.onError]);\n\n    /**\n     * Initializes Klarna SDK if it is already available and reinitialize\n     * it when the init time refreshes\n     */\n    useEffect(() => {\n        const isKlarnaAvailable = window.Klarna?.Payments?.init;\n        if (isKlarnaAvailable) {\n            initializeKlarnaWidget();\n        }\n    }, [widgetInitializationTime]);\n\n    useEffect(() => {\n        window.klarnaAsyncCallback = function () {\n            initializeKlarnaWidget();\n        };\n        const script = new Script(KLARNA_WIDGET_URL);\n        void script.load();\n\n        return () => {\n            script.remove();\n        };\n    }, [initializeKlarnaWidget]);\n\n    if (status !== 'error' && status !== 'success') {\n        return (\n            <div className=\"adyen-checkout__klarna-widget\">\n                <div ref={klarnaWidgetRef} />\n                {payButton({ status, disabled: status === 'loading', onClick: authorizeKlarna })}\n            </div>\n        );\n    }\n\n    return null;\n}\n"],"names":["KlarnaWidget","sdkData","paymentMethodType","widgetInitializationTime","payButton","props","klarnaWidgetRef","useRef","status","setStatus","useState","handleError","useCallback","onComplete","data","paymentData","details","initializeKlarnaWidget","window","Klarna","Payments","init","client_token","load","container","current","payment_method_category","res","show_form","error","onLoaded","authorizeKlarna","authorize","approved","authorization_token","onError","e","useEffect","isKlarnaAvailable","klarnaAsyncCallback","script","Script","KLARNA_WIDGET_URL","remove","h","div","className","ref","disabled","onClick"],"mappings":"oSAQO,SAASA,GAAaC,QAAEA,EAAOC,kBAAEA,EAAiBC,yBAAEA,EAAwBC,UAAEA,KAAcC,IAC/F,MAAMC,EAAkBC,EAAO,OACxBC,EAAQC,GAAaC,EAAS,SAE/BC,EAAcC,GAAY,KAC5BH,EAAU,SACVJ,EAAMQ,WAAW,CACbC,KAAM,CACFC,YAAaV,EAAMU,YACnBC,QAAS,CAAA,IAEjB,GACD,CAACX,EAAMU,YAAaV,EAAMQ,aAEvBI,EAAyBL,GAAY,KACvCM,OAAOC,OAAOC,SAASC,KAAK,CACxBC,aAAcrB,EAAQqB,eAG1BJ,OAAOC,OAAOC,SAASG,KACnB,CACIC,UAAWlB,EAAgBmB,QAC3BC,wBAAyBzB,EAAQyB,0BAErC,SAAUC,IAKDA,EAAIC,WAAeD,EAAIE,MACxBlB,IAEAN,EAAMyB,UAEd,GAAA,GAEL,CAAC7B,EAAQqB,aAAcrB,EAAQyB,0BAE5BK,EAAkBnB,GAAY,KAChCH,EAAU,WACV,IACIS,OAAOC,OAAOC,SAASY,UACnB,CACIN,wBAAyBzB,EAAQyB,0BAErC,SAAUC,IACe,IAAjBA,EAAIM,WAAuC,IAAlBN,EAAIC,WAE7BnB,EAAU,WACVJ,EAAMQ,WAAW,CACbC,KAAM,CACFC,YAAaV,EAAMU,YACnBC,QAAS,CACLkB,oBAAqBP,EAAIO,yBAI7BP,EAAIM,WAA8B,IAAlBN,EAAIC,UAO5BjB,KALAF,EAAU,SACVJ,EAAM8B,QAAQR,GAMtB,GAER,CAAE,MAAOS,GACLzB,GACJ,IACD,CAACV,EAAQyB,wBAAyBrB,EAAMQ,WAAYR,EAAM8B,UAyB7D,OAnBAE,GAAU,KACN,MAAMC,EAAoBpB,OAAOC,QAAQC,UAAUC,KAC/CiB,GACArB,GACJ,GACD,CAACd,IAEJkC,GAAU,KACNnB,OAAOqB,oBAAsB,WACzBtB,GACJ,EACA,MAAMuB,EAAS,IAAIC,EAAOC,GAG1B,OAFKF,EAAOjB,OAEL,KACHiB,EAAOG,QAAM,CACjB,GACD,CAAC1B,IAEW,UAAXT,GAAiC,YAAXA,EAElBoC,EAACC,MAAAA,CAAIC,UAAU,iCACXF,EAACC,MAAAA,CAAIE,IAAKzC,IACTF,EAAU,CAAEI,SAAQwC,SAAqB,YAAXxC,EAAsByC,QAASlB,KAKnE,IACX"}