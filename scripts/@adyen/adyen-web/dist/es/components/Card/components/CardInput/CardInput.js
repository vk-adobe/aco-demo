import{createElement as e,Fragment as r}from"../../../../external/preact/dist/preact.js";import{useRef as t,useMemo as o,useState as s,useCallback as n,useEffect as a}from"../../../../external/preact/hooks/dist/hooks.js";import i from"../../../internal/SecuredFields/SFP/SecuredFieldsProvider.js";import l from"./defaultProps.js";import{AddressModeOptions as d}from"./types.js";import{ENCRYPTED_CARD_NUMBER as u,DATE_POLICY_REQUIRED as c,CVC_POLICY_REQUIRED as m}from"../../../internal/SecuredFields/lib/constants.js";import{cardInputValidationRules as p,getRuleByNameAndMode as f,cardInputFormatters as h}from"./validate.js";import b from"../../../internal/SecuredFields/binLookup/extensions.js";import y from"../../../../utils/useForm/useForm.js";import{handlePartialAddressMode as S,extractPropsForSFP as g,extractPropsForCardFields as N,getLayout as A}from"./utils.js";import F from"../../../internal/Address/Specifications.js";import{StoredCardFieldsWrapper as C}from"./components/StoredCardFieldsWrapper.js";import{CardFieldsWrapper as j}from"./components/CardFieldsWrapper.js";import{getAutoJumpHandler as k,getFocusHandler as v,getAddressHandler as w}from"./handlers.js";import R from"../../../../_virtual/index.js";import{getPartialAddressValidationRules as x}from"../../../internal/Address/validate.js";import B from"../../../../core/Context/useImage.js";import{getArrayDifferences as E}from"../../../../utils/arrayUtils.js";import I from"../../../internal/FormInstruction/FormInstruction.js";import{PREFIX as P}from"../../../internal/Icon/constants.js";import V from"./useSRPanelForCardInputErrors.js";import O from"../Fastlane/FastlaneSignup.js";import{ANALYTICS_VALIDATION_ERROR_STR as q,ANALYTICS_DISPLAYED_STR as D,ANALYTICS_SELECTED_STR as M}from"../../../../core/Analytics/constants.js";import{fieldTypeToSnakeCase as _}from"../../../internal/SecuredFields/utils.js";import{getErrorMessageFromCode as L}from"../../../../core/Errors/utils.js";import{SF_ErrorCodes as T}from"../../../../core/Errors/constants.js";import{usePrevious as K}from"../../../../utils/hookUtils.js";import{AnalyticsInfoEvent as U}from"../../../../core/Analytics/AnalyticsInfoEvent.js";const H="dual_brand_button",z=l=>{const z=t(null),W=t(!1),$=B(),G=t(null),J=e=>{G.current=e},Q=t({});Object.keys(Q.current).length||l.setComponentRef(Q.current);const X=t(0),Y=t(!1),Z=o((()=>new F(l.specifications)),[l.specifications]);Q.current.sfp=z;const[ee,re]=s("ready"),[te,oe]=s({}),[se,ne]=s({...l.holderNameRequired&&{holderName:!1}}),[ae,ie]=s({...l.hasHolderName&&{holderName:l.data.holderName??""}}),[le,de]=s(""),[ue,ce]=s(!1),[me,pe]=s(c),[fe,he]=s(m),[be,ye]=s(null),[Se,ge]=s([]),[Ne,Ae]=s(l.storedPaymentMethodId?l.brand:""),Fe=l.billingAddressMode!==d.none&&l.billingAddressRequired,Ce=S(l.billingAddressMode),je=t(Ce&&l.data?.billingAddress?.country),[ke,ve]=s(!1),[we,Re]=s(Fe?l.data.billingAddress:null),[xe,Be]=s(!1),[Ee,Ie]=s(""),[Pe,Ve]=s({value:null}),[Oe,qe]=s(null),[De,Me]=s("card"),[_e,Le]=s(!1),{handleChangeFor:Te,triggerValidation:Ke,data:Ue,valid:He,errors:ze,setSchema:We,setData:$e,setValid:Ge,setErrors:Je}=y({schema:[],defaultData:l.data,formatters:h,rules:p}),Qe=!!Object.keys(l.installmentOptions).length&&"debit"!==l.fundingSource,Xe=l.showInstallmentAmounts??!0,Ye="kr"===(be??l.countryCode),Ze=l.configuration.koreanAuthenticationRequired&&Ye,er=xe&&"auto"===l.configuration.socialSecurityNumberMode||"show"===l.configuration.socialSecurityNumberMode,rr=(e,r)=>{l.onFocus({fieldType:e,event:r})},tr=(e,r)=>{l.onBlur({fieldType:e,event:r})},or=n((e=>{Me(e.brand),l.onBrand(e)}),[]),sr=v(de,rr,tr),nr=()=>A({props:l,showKCP:Ze,showBrazilianSSN:er,...l.billingAddressRequired&&{countrySpecificSchemas:Z.getAddressSchemaForCountry(we?.country),billingAddressRequiredFields:l.billingAddressRequiredFields}}),ar=n((e=>{const r="webInternalElement"!==e.fieldType?e.fieldType:e.name;qe(r)}),[]),ir=w($e,Ge,Je),lr=k(Y,z,nr()),dr=n((e=>{ur(e)}),[_e,Le]),ur=e=>{e.status&&("loading"==e.status?Le(!1):Le(!0))},cr=o((()=>b(l,{sfp:z},{dualBrandSelectElements:Se,setDualBrandSelectElements:ge,setSelectedBrandValue:Ae,issuingCountryCode:be,setIssuingCountryCode:ye},X)),[Se,be]);Q.current.showValidation=()=>{W.current=!0,fr?.(),z.current.showValidation(),Ke(["holderName","socialSecurityNumber","taxNumber"]),G?.current&&G.current.showValidation()},Q.current.processBinLookupResponse=(e,r)=>{cr.processBinLookup(e,r)},Q.current.setStatus=re,a((()=>(Q.current.setFocusOn=z.current.setFocusOn,Q.current.updateStyles=z.current.updateStyles,Q.current.handleUnsupportedCard=z.current.handleUnsupportedCard,()=>{z.current.destroy()})),[]),a((()=>{const e=[...l.hasHolderName?["holderName"]:[],...er?["socialSecurityNumber"]:[],...Ze?["taxNumber"]:[],...Fe?["billingAddress"]:[]];We(e)}),[l.hasHolderName,er,Ze]),a((()=>{ie({...ae,holderName:Ue.holderName??"",taxNumber:Ue.taxNumber}),Ie(Ue.socialSecurityNumber),Fe&&Re({...Ue.billingAddress}),ne({...se,holderName:!l.holderNameRequired||He.holderName,socialSecurityNumber:!!He.socialSecurityNumber&&He.socialSecurityNumber,taxNumber:!!He.taxNumber&&He.taxNumber,billingAddress:!!He.billingAddress&&He.billingAddress});const e=!!ze.billingAddress&&Object.entries(ze.billingAddress).reduce(((e,[,r])=>e||null!=r),!1);oe({...te,holderName:l.holderNameRequired&&ze.holderName?ze.holderName:null,socialSecurityNumber:er&&ze.socialSecurityNumber?ze.socialSecurityNumber:null,taxNumber:Ze&&ze.taxNumber?ze.taxNumber:null,billingAddress:Fe&&e?ze.billingAddress:null})}),[Ue,He,ze]);const{sortedErrorList:mr,previousSortedErrors:pr,clearSRPanel:fr}=V({errors:te,props:l,isValidating:W,retrieveLayout:nr,specifications:Z,billingAddress:we,sfp:z});a((()=>{if(mr){const e=E(mr,pr,"field");e?.forEach((e=>{const r=new U({type:q,target:_(e.field),validationErrorCode:e.errorCode,validationErrorMessage:L(e.errorCode,T)});l.onSubmitAnalytics(r)}))}}),[mr]),a((()=>{const e=se.holderName,r=ue,t=!Fe||se.billingAddress,o=!Ze||!!se.taxNumber&&!!se.encryptedPassword,s=!er||!!se.socialSecurityNumber,n=r&&e&&t&&o&&s,a=z.current.mapErrorsToValidationRuleResult(),i={...te,...a};l.onChange({data:ae,valid:se,errors:i,isValid:n,billingAddress:we,selectedBrandValue:Ne,storePaymentMethod:ke,socialSecurityNumber:Ee,installments:Pe})}),[ae,se,te,Ne,ke,Pe]),a((()=>{if(Se.length>0&&Se){const e=Se.map((e=>e.id)),r=e[0],t=e.toString(),o=new U({type:D,target:H,brand:r,configData:{dualBrands:t}});l.onSubmitAnalytics(o)}}),[Se]);const hr=K(Ne);a((()=>{if(hr?.length&&Ne?.length){const e=new U({type:M,target:H,brand:Ne});l.onSubmitAnalytics(e)}}),[Ne]);const br=l.storedPaymentMethodId?C:j;return e(r,null,e(i,{ref:z,...g(l),styles:{...l.styles},koreanAuthenticationRequired:l.configuration.koreanAuthenticationRequired,hasKoreanFields:!(!l.configuration.koreanAuthenticationRequired||"kr"!==l.countryCode),onChange:(e,r)=>{if(e.autoCompleteName){if(!l.hasHolderName)return;const r=f("holderName","blur")(e.autoCompleteName)?e.autoCompleteName:null;r&&($e("holderName",r),Ge("holderName",!0),Je("holderName",null))}else l.autoFocus&&X.current>0&&"handleOnFieldValid"===r?.event&&r?.fieldType===u&&e.valid.encryptedCardNumber&&lr(),ie({...ae,...e.data}),oe({...te,...e.errors}),ne({...se,...e.valid}),ce(e.isSfpValid),he(e.cvcPolicy),Be(e.showSocialSecurityNumber),pe(e.expiryDatePolicy)},onBrand:or,onFocus:sr,onStateUpdate:dr,type:l.brand,disableIOSArrowKeys:l.disableIOSArrowKeys?ar:null,render:({setRootNode:r,setFocusOn:t},o)=>e("div",{ref:r,className:R({"adyen-checkout__card-input":!0,"adyen-checkout-card-input__wrapper":!0,[`adyen-checkout__card-input--${l.fundingSource??"credit"}`]:!0,"adyen-checkout__card-input--loading":"loading"===ee}),role:"form"},_e&&e(I,null),e(br,{...N(l),data:ae,valid:se,errors:te,handleChangeFor:Te,focusedElement:le,setFocusOn:t,sfpState:o,cvcPolicy:fe,hasInstallments:Qe,showAmountsInInstallments:Xe,handleInstallments:Ve,brandsIcons:l.brandsIcons,formData:Ue,formErrors:ze,formValid:He,expiryDatePolicy:me,dualBrandSelectElements:Se,extensions:cr,selectedBrandValue:Ne,showKCP:Ze,showBrazilianSSN:er,socialSecurityNumber:Ee,handleOnStoreDetails:ve,setAddressRef:J,billingAddress:we,billingAddressValidationRules:Ce&&x(je.current),partialAddressSchema:Ce,handleAddress:ir,onAddressLookup:l.onAddressLookup,onAddressSelected:l.onAddressSelected,addressSearchDebounceMs:l.addressSearchDebounceMs,iOSFocusedField:Oe,onFieldFocusAnalytics:rr,onFieldBlurAnalytics:tr}))}),l.fastlaneConfiguration&&e(O,{...l.fastlaneConfiguration,currentDetectedBrand:De,onChange:l.onChange,onSubmitAnalytics:l.onSubmitAnalytics}),_e&&l.showPayButton&&l.payButton({status:ee,variant:l.isPayButtonPrimaryVariant?"primary":"secondary",icon:$({imageFolder:"components/"})(`${P}lock`)}))};z.defaultProps=l;export{z as default};
//# sourceMappingURL=CardInput.js.map
