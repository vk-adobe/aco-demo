{"version":3,"file":"CashAppPay.js","sources":["../../../../src/components/CashAppPay/CashAppPay.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport { CoreProvider } from '../../core/Context/CoreProvider';\nimport { CashAppComponent } from './components/CashAppComponent';\nimport CashAppService from './services/CashAppService';\nimport { CashAppSdkLoader } from './services/CashAppSdkLoader';\nimport { CashAppPayElementData, CashAppPayConfiguration, CashAppPayEventData } from './types';\nimport { ICashAppService } from './services/types';\nimport defaultProps from './defaultProps';\nimport RedirectButton from '../internal/RedirectButton';\nimport { payAmountLabel } from '../internal/PayButton';\nimport { TxVariants } from '../tx-variants';\nimport type { ICore } from '../../core/types';\nimport { PREFIX } from '../internal/Icon/constants';\n\nexport class CashAppPay extends UIElement<CashAppPayConfiguration> {\n    public static type = TxVariants.cashapp;\n\n    private readonly cashAppService: ICashAppService | undefined;\n\n    protected static defaultProps = defaultProps;\n\n    constructor(checkout: ICore, props?: CashAppPayConfiguration) {\n        super(checkout, props);\n\n        if (this.props.enableStoreDetails && this.props.storePaymentMethod) {\n            console.warn(\n                'CashAppPay: enableStoreDetails AND storePaymentMethod configuration properties should not be used together. That can lead to undesired behavior.'\n            );\n        }\n\n        if (this.props.storedPaymentMethodId) {\n            return;\n        }\n\n        this.cashAppService = new CashAppService(new CashAppSdkLoader(), {\n            storePaymentMethod: this.props.storePaymentMethod,\n            useCashAppButtonUi: this.props.showPayButton,\n            environment: this.props.environment,\n            amount: this.props.amount,\n            redirectURL: this.props.redirectURL,\n            clientId: this.props.configuration?.clientId,\n            scopeId: this.props.configuration?.scopeId,\n            button: this.props.button,\n            referenceId: this.props.referenceId\n        });\n    }\n\n    public formatProps(props: CashAppPayConfiguration) {\n        return {\n            ...props,\n            enableStoreDetails: props.session?.configuration?.enableStoreDetails || props.enableStoreDetails\n        };\n    }\n\n    public formatData(): CashAppPayElementData {\n        const { shopperWantsToStore, grantId, onFileGrantId, cashTag, customerId } = this.state.data || {};\n        const { storePaymentMethod: storePaymentMethodSetByMerchant, storedPaymentMethodId } = this.props;\n\n        /**\n         * We include 'storePaymentMethod' flag if we either Display the Checkbox OR if it is non-sessions flow AND the merchant wants to store the payment method\n         */\n        const includeStorePaymentMethod = this.props.enableStoreDetails || (!this.props.session && storePaymentMethodSetByMerchant);\n\n        if (storedPaymentMethodId) {\n            return {\n                paymentMethod: {\n                    type: CashAppPay.type,\n                    storedPaymentMethodId\n                }\n            };\n        }\n\n        const shouldAddOnFileProperties = onFileGrantId && cashTag;\n\n        return {\n            paymentMethod: {\n                type: CashAppPay.type,\n                ...(grantId && { grantId }),\n                ...(customerId && { customerId }),\n                ...(shouldAddOnFileProperties && { onFileGrantId, cashtag: cashTag })\n            },\n            ...(includeStorePaymentMethod && { storePaymentMethod: storePaymentMethodSetByMerchant || shopperWantsToStore })\n        };\n    }\n\n    get displayName() {\n        if (this.props.storedPaymentMethodId && this.props.cashtag) {\n            return this.props.cashtag;\n        }\n        return this.props.name;\n    }\n\n    get additionalInfo() {\n        return this.props.storedPaymentMethodId ? 'Cash App Pay' : '';\n    }\n\n    public submit = () => {\n        const { onClick, storedPaymentMethodId } = this.props;\n\n        if (storedPaymentMethodId) {\n            super.submit();\n            return;\n        }\n\n        let onClickPromiseRejected = false;\n\n        new Promise<void>((resolve, reject) => onClick({ resolve, reject }))\n            .catch(() => {\n                onClickPromiseRejected = true;\n                throw Error('onClick rejected');\n            })\n            .then(() => {\n                return this.cashAppService.createCustomerRequest();\n            })\n            .then(() => {\n                this.cashAppService.begin();\n            })\n            .catch(error => {\n                if (onClickPromiseRejected) {\n                    // Swallow exception triggered by onClick reject\n                    return;\n                }\n                this.handleError(error);\n            });\n    };\n\n    public get isValid(): boolean {\n        return true;\n    }\n\n    private handleOnChangeStoreDetails = (storePayment: boolean) => {\n        const data = { ...this.state.data, shopperWantsToStore: storePayment };\n        this.setState({ data });\n    };\n\n    private handleAuthorize = (cashAppPaymentData: CashAppPayEventData): void => {\n        const data = { ...this.state.data, ...cashAppPaymentData };\n        this.setState({ data, valid: {}, errors: {}, isValid: true });\n        super.submit();\n    };\n\n    render() {\n        return (\n            <CoreProvider i18n={this.props.i18n} resources={this.resources} loadingContext={this.props.loadingContext}>\n                {this.props.storedPaymentMethodId ? (\n                    <RedirectButton\n                        showPayButton={this.props.showPayButton}\n                        label={payAmountLabel(this.props.i18n, this.props.amount)}\n                        icon={this.resources?.getImage({ imageFolder: 'components/' })(`${PREFIX}lock`)}\n                        name={this.displayName}\n                        amount={this.props.amount}\n                        payButton={this.payButton}\n                        onSubmit={this.submit}\n                        ref={ref => {\n                            this.componentRef = ref;\n                        }}\n                    />\n                ) : (\n                    <CashAppComponent\n                        ref={ref => {\n                            this.componentRef = ref;\n                        }}\n                        enableStoreDetails={this.props.enableStoreDetails}\n                        cashAppService={this.cashAppService}\n                        onChangeStoreDetails={this.handleOnChangeStoreDetails}\n                        onError={this.handleError}\n                        onClick={this.submit}\n                        onAuthorize={this.handleAuthorize}\n                    />\n                )}\n            </CoreProvider>\n        );\n    }\n}\n\nexport default CashAppPay;\n"],"names":["CashAppPay","UIElement","formatProps","props","enableStoreDetails","session","configuration","formatData","shopperWantsToStore","grantId","onFileGrantId","cashTag","customerId","this","state","data","storePaymentMethod","storePaymentMethodSetByMerchant","storedPaymentMethodId","includeStorePaymentMethod","paymentMethod","type","cashtag","displayName","name","additionalInfo","isValid","render","h","CoreProvider","i18n","resources","loadingContext","RedirectButton","showPayButton","label","payAmountLabel","amount","icon","getImage","imageFolder","PREFIX","payButton","onSubmit","submit","ref","componentRef","CashAppComponent","cashAppService","onChangeStoreDetails","handleOnChangeStoreDetails","onError","handleError","onClick","onAuthorize","handleAuthorize","constructor","checkout","super","_define_property","onClickPromiseRejected","Promise","resolve","reject","catch","Error","then","createCustomerRequest","begin","error","storePayment","setState","cashAppPaymentData","valid","errors","console","warn","CashAppService","CashAppSdkLoader","useCashAppButtonUi","environment","redirectURL","clientId","scopeId","button","referenceId","TxVariants","cashapp","defaultProps"],"mappings":"wxBAeO,MAAMA,UAAmBC,EAiCrBC,WAAAA,CAAYC,GACf,MAAO,IACAA,EACHC,mBAAoBD,EAAME,SAASC,eAAeF,oBAAsBD,EAAMC,mBAEtF,CAEOG,UAAAA,GACH,MAAMC,oBAAEA,EAAmBC,QAAEA,EAAOC,cAAEA,EAAaC,QAAEA,EAAOC,WAAEA,GAAeC,KAAKC,MAAMC,MAAQ,CAAC,GACzFC,mBAAoBC,EAA+BC,sBAAEA,GAA0BL,KAAKV,MAKtFgB,EAA4BN,KAAKV,MAAMC,qBAAwBS,KAAKV,MAAME,SAAWY,EAE3F,GAAIC,EACA,MAAO,CACHE,cAAe,CACXC,KAAMrB,EAAWqB,KACjBH,0BAOZ,MAAO,CACHE,cAAe,CACXC,KAAMrB,EAAWqB,QACbZ,GAAW,CAAEA,cACbG,GAAc,CAAEA,iBANMF,GAAiBC,GAOV,CAAED,gBAAeY,QAASX,OAE3DQ,GAA6B,CAAEH,mBAAoBC,GAAmCT,GAElG,CAEA,eAAIe,GACA,OAAIV,KAAKV,MAAMe,uBAAyBL,KAAKV,MAAMmB,QACxCT,KAAKV,MAAMmB,QAEfT,KAAKV,MAAMqB,IACtB,CAEA,kBAAIC,GACA,OAAOZ,KAAKV,MAAMe,sBAAwB,eAAiB,EAC/D,CAgCA,WAAWQ,GACP,OAAO,CACX,CAaAC,MAAAA,GACI,OACIC,EAACC,EAAAA,CAAaC,KAAMjB,KAAKV,MAAM2B,KAAMC,UAAWlB,KAAKkB,UAAWC,eAAgBnB,KAAKV,MAAM6B,gBACtFnB,KAAKV,MAAMe,sBACRU,EAACK,EAAAA,CACGC,cAAerB,KAAKV,MAAM+B,cAC1BC,MAAOC,EAAevB,KAAKV,MAAM2B,KAAMjB,KAAKV,MAAMkC,QAClDC,KAAMzB,KAAKkB,WAAWQ,SAAS,CAAEC,YAAa,eAAxC3B,CAAyD,GAAG4B,SAClEjB,KAAMX,KAAKU,YACXc,OAAQxB,KAAKV,MAAMkC,OACnBK,UAAW7B,KAAK6B,UAChBC,SAAU9B,KAAK+B,OACfC,IAAKA,IACDhC,KAAKiC,aAAeD,CAAAA,IAI5BjB,EAACmB,EAAAA,CACGF,IAAKA,IACDhC,KAAKiC,aAAeD,CAAAA,EAExBzC,mBAAoBS,KAAKV,MAAMC,mBAC/B4C,eAAgBnC,KAAKmC,eACrBC,qBAAsBpC,KAAKqC,2BAC3BC,QAAStC,KAAKuC,YACdC,QAASxC,KAAK+B,OACdU,YAAazC,KAAK0C,kBAKtC,CAvJAC,WAAAA,CAAYC,EAAiBtD,GACzBuD,MAAMD,EAAUtD,GALpBwD,EAAA9C,KAAiBmC,sBAAjB,GA+EAW,OAAOf,UAAS,KACZ,MAAMS,QAAEA,EAAOnC,sBAAEA,GAA0BL,KAAKV,MAEhD,GAAIe,EAEA,YADAwC,MAAMd,SAIV,IAAIgB,GAAyB,EAE7B,IAAIC,SAAc,CAACC,EAASC,IAAWV,EAAQ,CAAES,UAASC,aACrDC,OAAM,KAEH,MADAJ,GAAyB,EACnBK,MAAM,mBAAA,IAEfC,MAAK,IACKrD,KAAKmC,eAAemB,0BAE9BD,MAAK,KACFrD,KAAKmC,eAAeoB,OAAK,IAE5BJ,OAAMK,IACCT,GAIJ/C,KAAKuC,YAAYiB,EAAAA,GACrB,IAORV,EAAA9C,KAAQqC,8BAA8BoB,IAClC,MAAMvD,EAAO,IAAKF,KAAKC,MAAMC,KAAMP,oBAAqB8D,GACxDzD,KAAK0D,SAAS,CAAExD,QAAK,IAGzB4C,EAAA9C,KAAQ0C,mBAAmBiB,IACvB,MAAMzD,EAAO,IAAKF,KAAKC,MAAMC,QAASyD,GACtC3D,KAAK0D,SAAS,CAAExD,OAAM0D,MAAO,CAAC,EAAGC,OAAQ,CAAC,EAAGhD,SAAS,IACtDgC,MAAMd,QAAAA,IAlHF/B,KAAKV,MAAMC,oBAAsBS,KAAKV,MAAMa,oBAC5C2D,QAAQC,KACJ,oJAIJ/D,KAAKV,MAAMe,wBAIfL,KAAKmC,eAAiB,IAAI6B,EAAe,IAAIC,EAAoB,CAC7D9D,mBAAoBH,KAAKV,MAAMa,mBAC/B+D,mBAAoBlE,KAAKV,MAAM+B,cAC/B8C,YAAanE,KAAKV,MAAM6E,YACxB3C,OAAQxB,KAAKV,MAAMkC,OACnB4C,YAAapE,KAAKV,MAAM8E,YACxBC,SAAUrE,KAAKV,MAAMG,eAAe4E,SACpCC,QAAStE,KAAKV,MAAMG,eAAe6E,QACnCC,OAAQvE,KAAKV,MAAMiF,OACnBC,YAAaxE,KAAKV,MAAMkF,cAEhC,EA9BA1B,EADS3D,EACKqB,OAAOiE,EAAWC,SAIhC5B,EALS3D,EAKQwF,eAAeA"}