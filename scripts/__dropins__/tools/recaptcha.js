/*! Copyright 2025 Adobe
All Rights Reserved. */
const n={failedFetch:"Failed to fetch config from backend with status:",failedSetStorageConfig:"Failed to set storage config",failedGetStorageConfig:"Configuration could not be loaded.",failedExecutionRecaptcha:"Recaptcha execution failed",failedInitializing:"An error occurred while initializing ReCaptcha:"},S={PLACE_ORDER:"placeOrder",CONTACT:"contactUs",CUSTOMER_LOGIN:"generateCustomerToken",CUSTOMER_FORGOT_PASSWORD:"requestPasswordResetEmail",CUSTOMER_CREATE:"createCustomerV2",CUSTOMER_EDIT:"updateCustomerV2",NEWSLETTER:"subscribeEmailToNewsletter",PRODUCT_REVIEW:"createProductReview",SENDFRIEND:"SENDFRIEND",BRAINTREE:"BRAINTREE"},m=".grecaptcha-badge iframe",H=(i,e)=>{if(i&&i.forms){const t=i.forms.concat(e).map(r=>typeof r!="string"?{...r,enabledBadgePlace:!1}:{badgeId:S[r],enabledBadgePlace:!1});return{...i,forms:[...new Set(t)]}}},b=async(i,e=1,t=1e3)=>{const r=sessionStorage.getItem(i);return r!==null?JSON.parse(r):e>0?(await new Promise(a=>setTimeout(a,t)),b(i,e-1,t)):null},G=(i,e,t)=>{if(!i||!e.websiteKey)return null;try{sessionStorage.setItem(i,JSON.stringify(e))}catch(r){return t&&console.error(n.failedSetStorageConfig,r),null}},R=i=>new Promise((e,t)=>{try{if(document.querySelector(i)){e();return}const r=new MutationObserver(()=>{document.querySelector(i)&&(e(),r.disconnect())});r.observe(document.body,{childList:!0,subtree:!1})}catch(r){t(r)}}),Q=async()=>{try{return await R(m),!0}catch{return!1}},P=i=>{const e=t=>t.replace(/_([a-z])/g,(r,a)=>a.toUpperCase());return Object.keys(i).reduce((t,r)=>{const a=e(r);return t[a]=i[r],t},{})},{failedExecutionRecaptcha:u}=n,T=async i=>{if(!window.grecaptcha)return Promise.reject(u);try{return await window.grecaptcha.execute(i,{action:"click"})}catch(e){return Promise.reject(`${u} : ${e}`)}},v=()=>new Promise(i=>{const e=new MutationObserver((r,a)=>{window.grecaptcha&&(a.disconnect(),i(!0))}),t={childList:!0,subtree:!0,attributes:!0};e.observe(document.body,t)}),F=async(i,e,t)=>(window.grecaptcha||await v(),grecaptcha.ready(()=>{const r=document.querySelectorAll(`#${i}`);r.length&&(r.forEach(a=>a.id=`${a.id}_${Math.random().toString(36)}`),r.forEach(a=>{if(a.innerHTML==="")try{grecaptcha.render(a.id,{sitekey:e.websiteKey,badge:e.badgePosition,size:"invisible",theme:e.theme??"light"})}catch(s){t&&console.error(s)}}))})),k=`query {
  recaptchaV3Config {
    is_enabled
    website_key
    minimum_score
    badge_position
    language_code
    failure_message
    forms
    theme
  } 
}`,A={"Content-Type":"application/json",Accept:"application/json"};class _{constructor(){this._fetchGraphQlHeaders={},this._beforeHooks=[],this._afterHooks=[]}get endpoint(){return this._endpoint}get fetchGraphQlHeaders(){return this._fetchGraphQlHeaders}setEndpoint(e){this._endpoint=e}setFetchGraphQlHeader(e,t){this._fetchGraphQlHeaders={...this.fetchGraphQlHeaders,[e]:t}}removeFetchGraphQlHeader(e){delete this._fetchGraphQlHeaders[e]}setFetchGraphQlHeaders(e){typeof e=="function"?this._fetchGraphQlHeaders={...this._fetchGraphQlHeaders,...e(this._fetchGraphQlHeaders)}:this._fetchGraphQlHeaders={...e}}addBeforeHook(e){this._beforeHooks.push(e)}addAfterHook(e){this._afterHooks.push(e)}async fetchGraphQl(e,t){const r=this.endpoint,a=this.fetchGraphQlHeaders;if(!r)throw Error('Missing "url"');const s=(t==null?void 0:t.method)??"POST",o=t==null?void 0:t.cache,C=t==null?void 0:t.signal;let p;const h=new URL(r),w={...A,...a};s==="POST"&&(p=JSON.stringify({query:e,variables:t==null?void 0:t.variables})),s==="GET"&&(h.searchParams.append("query",I(e)),t!=null&&t.variables&&h.searchParams.append("variables",JSON.stringify(t.variables)));let c={method:s,headers:w,body:p,cache:o,signal:C};return c=await this._beforeHooks.reduce(async(d,l)=>l(await d),Promise.resolve(c)),await fetch(h,c).then(d=>d.json().then(l=>this._afterHooks.reduce(async(y,E)=>E(c,await y),Promise.resolve(l))))}getConfig(){return{endpoint:this.endpoint,fetchGraphQlHeaders:this.fetchGraphQlHeaders}}getMethods(){return{setEndpoint:this.setEndpoint.bind(this),setFetchGraphQlHeader:this.setFetchGraphQlHeader.bind(this),removeFetchGraphQlHeader:this.removeFetchGraphQlHeader.bind(this),setFetchGraphQlHeaders:this.setFetchGraphQlHeaders.bind(this),fetchGraphQl:this.fetchGraphQl.bind(this),getConfig:this.getConfig.bind(this),addBeforeHook:this.addBeforeHook.bind(this),addAfterHook:this.addAfterHook.bind(this)}}}const f=new _;class O extends _{get endpoint(){return this._endpoint??f.endpoint}get fetchGraphQlHeaders(){return this._endpoint?this._fetchGraphQlHeaders:{...this._fetchGraphQlHeaders,...f.fetchGraphQlHeaders}}}function I(i){return i=i.replace(/#.*/g,""),i=i.replace(/\s+/g," "),i.trim()}const{setEndpoint:L,setFetchGraphQlHeaders:N,setFetchGraphQlHeader:$,removeFetchGraphQlHeader:U,fetchGraphQl:K,getConfig:D,addBeforeHook:x,addAfterHook:V}=f.getMethods(),g=new O().getMethods();class B{constructor(){var e;this._enableReCAPTCHA=!1,this._recaptchaBackendEndpoint=((e=g.getConfig())==null?void 0:e.endpoint)||"",this._recaptchaScriptUrl="https://www.google.com/recaptcha/api.js",this._configStorageKey="recaptchaConfig",this._logger=!1}async _updateBadgePosition(e,t){if(t)if((t==null?void 0:t.badgePosition)==="inline")await F(e,t,this._logger);else{if(!await Q())return;const a=document.querySelector(m);t.theme&&a&&!a.src.includes("theme=dark")&&!a.src.includes("theme=light")&&a.setAttribute("src",`${a.src}&theme=${t.theme}`)}}async _addRecaptchaScript(){const e=await this._loadConfig();if(!document.getElementById("recaptchaId")&&e){const t=e.websiteKey,r=e.badgePosition==="inline",a=e.languageCode;if(!t)return;const s=document.createElement("script");s.setAttribute("id","recaptchaId"),s.defer=!0,s.src=r?`${this._recaptchaScriptUrl}?render=${t}&badge=none&hl=${a}`:`${this._recaptchaScriptUrl}?render=${t}&badge=${e.badgePosition}&hl=${a}`,document.head.appendChild(s)}}async _fetchStoreConfig(){var e;try{const t=await g.fetchGraphQl(k,{method:"GET",cache:"force-cache"});if((e=t==null?void 0:t.errors)!=null&&e.length){this._logger&&console.error(t.errors[0].message);return}return t}catch(t){this._logger&&console.error(`${n.failedFetch}:`,t)}}async _loadConfig(){const e=await b(this._configStorageKey);return e?(this._enableReCAPTCHA=!!e.isEnabled,e):(this._logger&&console.error(n.failedGetStorageConfig),null)}setEndpoint(e){e&&(this._recaptchaBackendEndpoint=e,g.setEndpoint(e))}async setConfig(e){var t,r;try{const a=await this._fetchStoreConfig();if(!((t=a==null?void 0:a.data)!=null&&t.recaptchaV3Config)){sessionStorage.removeItem(this._configStorageKey);return}const s=P((r=a==null?void 0:a.data)==null?void 0:r.recaptchaV3Config),o=H(s,e);o&&G(this._configStorageKey,o,this._logger)}catch(a){this._logger&&console.error(n.failedSetStorageConfig,a),sessionStorage.removeItem(this._configStorageKey)}}async initReCaptcha(e=3e3){setTimeout(()=>{(async()=>{try{const t=await this._loadConfig();if(!(t!=null&&t.forms)||!t.isEnabled)return;await this._addRecaptchaScript(),t.badgePosition==="inline"?await Promise.all(t.forms.map(r=>this._updateBadgePosition(r.badgeId,t))):await this._updateBadgePosition("",t)}catch(t){this._logger&&console.error(n.failedInitializing,t)}})()},e)}async verifyReCaptcha(){try{const e=await this._loadConfig();return!(e!=null&&e.forms)||!e.websiteKey||!e.isEnabled?void 0:await T(e.websiteKey)}catch(e){this._logger&&console.error(e)}}enableLogger(e){this._logger=e}getMethods(){return{enableLogger:this.enableLogger.bind(this),setEndpoint:this.setEndpoint.bind(this),setConfig:this.setConfig.bind(this),initReCaptcha:this.initReCaptcha.bind(this),verifyReCaptcha:this.verifyReCaptcha.bind(this)}}}const M=new B,{initReCaptcha:j,verifyReCaptcha:z,setEndpoint:J,setConfig:q,enableLogger:W}=M.getMethods();export{B as RecaptchaModule,W as enableLogger,j as initReCaptcha,g as recaptchaFetchApi,q as setConfig,J as setEndpoint,z as verifyReCaptcha};
//# sourceMappingURL=recaptcha.js.map
