{"version":3,"file":"assets.js","sources":["/@dropins/tools/src/lib/aem/assets.ts"],"sourcesContent":["import { provider as UI, Image } from '@adobe-commerce/elsie/components';\nimport { getConfigValue } from '@adobe-commerce/elsie/lib/aem/configs';\n\ninterface AemAssetsParams {\n  quality?: number;\n  format?: string;\n  crop?: {\n    xOrigin?: number;\n    yOrigin?: number;\n    width?: number;\n    height?: number;\n  };\n  size?: {\n    width?: number;\n    height?: number;\n  };\n  width?: number;\n  height?: number;\n  [key: string]: any;\n}\n\ninterface AemAssetsImageConfig {\n  wrapper?: HTMLElement;\n  alias: string;\n  params: AemAssetsParams;\n  imageProps: {\n    src: string;\n    width?: number;\n    height?: number;\n    [key: string]: any;\n  };\n  src?: string;\n}\n\ninterface RenderContext {\n  replaceWith: (element: HTMLElement) => void;\n}\n\nexport function isAemAssetsEnabled(): boolean {\n  const config = getConfigValue('commerce-assets-enabled');\n\n  return config && (\n    (typeof config === 'string' && config.toLowerCase() === 'true')\n    || (typeof config === 'boolean' && config === true)\n  );\n}\n\nexport function getDefaultAemAssetsOptimizationParams(): { quality: number; format: string } {\n  // See: https://adobe-aem-assets-delivery-experimental.redoc.ly/\n  return {\n    quality: 80,\n    format: 'webp',\n  };\n}\n\n/**\n * Normalizes the given URL to ensure it is a valid URL.\n * @param {string} url - The URL to normalize.\n * @returns {string} The normalized URL.\n */\nfunction normalizeUrl(url: string): string {\n  let imageUrl = url;\n\n  if (imageUrl.startsWith('//')) {\n    // Use current window's protocol.\n    const { protocol } = window.location;\n    console.log('protocol', protocol);\n    imageUrl = protocol + imageUrl;\n  }\n\n  return imageUrl;\n}\n\nexport function isAemAssetsUrl(url: string | URL): boolean {\n  const assetsUrl = typeof url === 'string' ? new URL(normalizeUrl(url)) : url;\n\n  if (!assetsUrl.pathname.startsWith('/adobe/assets/urn:aaid:aem')) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function generateAemAssetsOptimizedUrl(url: string, alias: string, params: AemAssetsParams = {}): string {\n  const defaultParams = getDefaultAemAssetsOptimizationParams();\n  const mergedParams: AemAssetsParams = { ...defaultParams, ...params };\n\n  // Destructure the ones that need special handling\n  const {\n    format,\n    crop,\n    size,\n    ...optimizedParams\n  } = mergedParams;\n\n  const searchParams = new URLSearchParams(optimizedParams);\n\n  if (crop) {\n    const [xOrigin, yOrigin] = [crop.xOrigin || 0, crop.yOrigin || 0];\n    const [width, height] = [crop.width || 100, crop.height || 100];\n\n    const cropTransform = `${xOrigin}p,${yOrigin}p,${width}p,${height}p`;\n    searchParams.set('crop', cropTransform);\n  }\n\n  // Both values must be present\n  if (size && size.width && size.height) {\n    searchParams.set('size', `${size.width},${size.height}`);\n  }\n\n  return `${url}/as/${alias}.${format}?${searchParams.toString()}`;\n}\n\nexport function tryGenerateAemAssetsOptimizedUrl(url: string, alias: string, params: AemAssetsParams = {}): string {\n  const assetsEnabled = isAemAssetsEnabled();\n\n  if (!(assetsEnabled)) {\n    // No-op, doesn't do anything.\n    return url;\n  }\n\n  const assetsUrl = new URL(normalizeUrl(url));\n\n  if (!isAemAssetsUrl(assetsUrl)) {\n    // Not an AEM Assets URL, so no-op.\n    return url;\n  }\n\n  const base = assetsUrl.origin + assetsUrl.pathname;\n  return generateAemAssetsOptimizedUrl(base, alias, params);\n}\n\nexport function makeAemAssetsImageSlot(\n  config: AemAssetsImageConfig,\n) {\n  return (ctx: RenderContext) => {\n    const {\n      wrapper,\n      alias,\n      params,\n      imageProps,\n      src,\n    } = config;\n\n    const container = wrapper ?? document.createElement('div');\n    const imageSrc = generateAemAssetsOptimizedUrl(src || imageProps.src, alias, params);\n\n    UI.render(Image as any, {\n      ...imageProps,\n\n      src: imageSrc,\n      params: {\n        width: params.width,\n\n        // If not null, they will be applied by default.\n        // And they are not compatible with the AEM Assets API.\n        crop: null,\n        fit: null,\n        auto: null,\n      },\n    })(container);\n\n    ctx.replaceWith(container);\n  };\n}\n\nexport function tryRenderAemAssetsImage(ctx: RenderContext, config: AemAssetsImageConfig): void {\n  // Renders an equivalent of the default image.\n  function renderDefaultImage(): void {\n    const container = config.wrapper ?? document.createElement('div');\n    const { imageProps } = config;\n\n    (UI.render as any)(Image, imageProps)(container);\n    ctx.replaceWith(container);\n  }\n\n  const assetsEnabled = isAemAssetsEnabled();\n\n  if (!(assetsEnabled)) {\n    // No-op, render the default image.\n    renderDefaultImage();\n    return;\n  }\n\n  const { imageProps, src, ...slotConfig } = config;\n  const assetsUrl = new URL(normalizeUrl(src ?? imageProps.src));\n\n  if (!isAemAssetsUrl(assetsUrl)) {\n    // Not an AEM Assets URL, so render the default image.\n    renderDefaultImage();\n    return;\n  }\n\n  makeAemAssetsImageSlot({\n    // Use the default image props for params and src.\n    // Unless overriden by the slot config.\n    src: assetsUrl.toString(),\n    params: {\n      width: imageProps.width,\n      height: imageProps.height,\n      ...slotConfig.params,\n    },\n    imageProps,\n    alias: slotConfig.alias,\n    wrapper: slotConfig.wrapper,\n  })(ctx);\n}\n"],"names":["isAemAssetsEnabled","config","getConfigValue","getDefaultAemAssetsOptimizationParams","normalizeUrl","url","imageUrl","protocol","isAemAssetsUrl","generateAemAssetsOptimizedUrl","alias","params","mergedParams","format","crop","size","optimizedParams","searchParams","xOrigin","yOrigin","width","height","cropTransform","tryGenerateAemAssetsOptimizedUrl","assetsUrl","base","makeAemAssetsImageSlot","ctx","wrapper","imageProps","src","container","imageSrc","UI","Image","tryRenderAemAssetsImage","renderDefaultImage","slotConfig"],"mappings":"sWAsCO,SAASA,GAA8B,CACtC,MAAAC,EAASC,EAAe,yBAAyB,EAEhD,OAAAD,IACJ,OAAOA,GAAW,UAAYA,EAAO,gBAAkB,QACpD,OAAOA,GAAW,WAAaA,IAAW,GAElD,CAEO,SAASE,GAA6E,CAEpF,MAAA,CACL,QAAS,GACT,OAAQ,MACV,CACF,CAOA,SAASC,EAAaC,EAAqB,CACzC,IAAIC,EAAWD,EAEX,GAAAC,EAAS,WAAW,IAAI,EAAG,CAEvB,KAAA,CAAE,SAAAC,GAAa,OAAO,SACpB,QAAA,IAAI,WAAYA,CAAQ,EAChCD,EAAWC,EAAWD,CAAA,CAGjB,OAAAA,CACT,CAEO,SAASE,EAAeH,EAA4B,CAGzD,MAAK,GAFa,OAAOA,GAAQ,SAAW,IAAI,IAAID,EAAaC,CAAG,CAAC,EAAIA,GAE1D,SAAS,WAAW,4BAA4B,CAKjE,CAEO,SAASI,EAA8BJ,EAAaK,EAAeC,EAA0B,CAAA,EAAY,CAE9G,MAAMC,EAAgC,CAAE,GADlBT,EAAsC,EACF,GAAGQ,CAAO,EAG9D,CACJ,OAAAE,EACA,KAAAC,EACA,KAAAC,EACA,GAAGC,CAAA,EACDJ,EAEEK,EAAe,IAAI,gBAAgBD,CAAe,EAExD,GAAIF,EAAM,CACF,KAAA,CAACI,EAASC,CAAO,EAAI,CAACL,EAAK,SAAW,EAAGA,EAAK,SAAW,CAAC,EAC1D,CAACM,EAAOC,CAAM,EAAI,CAACP,EAAK,OAAS,IAAKA,EAAK,QAAU,GAAG,EAExDQ,EAAgB,GAAGJ,CAAO,KAAKC,CAAO,KAAKC,CAAK,KAAKC,CAAM,IACpDJ,EAAA,IAAI,OAAQK,CAAa,CAAA,CAIxC,OAAIP,GAAQA,EAAK,OAASA,EAAK,QAChBE,EAAA,IAAI,OAAQ,GAAGF,EAAK,KAAK,IAAIA,EAAK,MAAM,EAAE,EAGlD,GAAGV,CAAG,OAAOK,CAAK,IAAIG,CAAM,IAAII,EAAa,SAAA,CAAU,EAChE,CAEO,SAASM,EAAiClB,EAAaK,EAAeC,EAA0B,CAAA,EAAY,CAGjH,GAAI,CAFkBX,EAAmB,EAIhC,OAAAK,EAGT,MAAMmB,EAAY,IAAI,IAAIpB,EAAaC,CAAG,CAAC,EAEvC,GAAA,CAACG,EAAegB,CAAS,EAEpB,OAAAnB,EAGH,MAAAoB,EAAOD,EAAU,OAASA,EAAU,SACnC,OAAAf,EAA8BgB,EAAMf,EAAOC,CAAM,CAC1D,CAEO,SAASe,EACdzB,EACA,CACA,OAAQ0B,GAAuB,CACvB,KAAA,CACJ,QAAAC,EACA,MAAAlB,EACA,OAAAC,EACA,WAAAkB,EACA,IAAAC,CAAA,EACE7B,EAEE8B,EAAYH,GAAW,SAAS,cAAc,KAAK,EACnDI,EAAWvB,EAA8BqB,GAAOD,EAAW,IAAKnB,EAAOC,CAAM,EAEnFsB,EAAG,OAAOC,EAAc,CACtB,GAAGL,EAEH,IAAKG,EACL,OAAQ,CACN,MAAOrB,EAAO,MAId,KAAM,KACN,IAAK,KACL,KAAM,IAAA,CAET,CAAA,EAAEoB,CAAS,EAEZJ,EAAI,YAAYI,CAAS,CAC3B,CACF,CAEgB,SAAAI,EAAwBR,EAAoB1B,EAAoC,CAE9F,SAASmC,GAA2B,CAClC,MAAML,EAAY9B,EAAO,SAAW,SAAS,cAAc,KAAK,EAC1D,CAAE,WAAA4B,CAAAA,EAAe5B,EAEtBgC,EAAG,OAAeC,EAAOL,CAAU,EAAEE,CAAS,EAC/CJ,EAAI,YAAYI,CAAS,CAAA,CAK3B,GAAI,CAFkB/B,EAAmB,EAEnB,CAEDoC,EAAA,EACnB,MAAA,CAGF,KAAM,CAAE,WAAAP,EAAY,IAAAC,EAAK,GAAGO,CAAe,EAAApC,EACrCuB,EAAY,IAAI,IAAIpB,EAAa0B,GAAOD,EAAW,GAAG,CAAC,EAEzD,GAAA,CAACrB,EAAegB,CAAS,EAAG,CAEXY,EAAA,EACnB,MAAA,CAGqBV,EAAA,CAGrB,IAAKF,EAAU,SAAS,EACxB,OAAQ,CACN,MAAOK,EAAW,MAClB,OAAQA,EAAW,OACnB,GAAGQ,EAAW,MAChB,EACA,WAAAR,EACA,MAAOQ,EAAW,MAClB,QAASA,EAAW,OACrB,CAAA,EAAEV,CAAG,CACR"}