{"version":3,"file":"GiftCards.js","sources":["/@dropins/storefront-cart/src/containers/GiftCards/GiftCards.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { HTMLAttributes, useState, useEffect } from 'preact/compat';\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { Coupons as CouponsComponent } from '@/cart/components';\nimport { Button, Input, Icon, Tag } from '@adobe-commerce/elsie/components';\nimport { Close, GiftCard } from '@adobe-commerce/elsie/icons';\nimport { applyGiftCardToCart, removeGiftCardFromCart } from '@/cart/api';\nimport { events } from '@adobe-commerce/event-bus';\nimport { useText } from '@adobe-commerce/elsie/i18n';\n\nexport interface GiftCardsProps extends HTMLAttributes<HTMLDivElement> {}\n\nexport const GiftCards: Container<GiftCardsProps> = ({\n  children,\n  ...props\n}) => {\n  const [successfulGiftCardSet, setSuccessfulGiftCardSet] = useState(new Set());\n  const [appliedGiftCardsArray, setAppliedGiftCardsArray] = useState<string[]>(\n    []\n  );\n  const [giftCardError, setGiftCardError] = useState(new Set());\n\n  const dictionary = useText({\n    giftCardTitle: 'Cart.PriceSummary.giftCard.title',\n    applyButton: 'Cart.PriceSummary.giftCard.applyAction',\n    placeholder: 'Cart.PriceSummary.giftCard.placeholder',\n    ariaLabel: 'Cart.PriceSummary.giftCard.ariaLabel',\n    ariaLabelRemove: 'Cart.PriceSummary.giftCard.ariaLabelRemove',\n    empty: 'Cart.PriceSummary.giftCard.errors.empty',\n  });\n\n  const handleApplyGiftCard = async (value: { giftCardCode: string }) => {\n    const giftCardCode = value?.giftCardCode;\n\n    if (giftCardCode === '') {\n      setGiftCardError(new Set([dictionary.empty]));\n      return true;\n    }\n\n    const newSet = new Set(successfulGiftCardSet);\n    newSet.add(giftCardCode);\n    setGiftCardError(new Set());\n\n    applyGiftCardToCart(giftCardCode)\n      .then((result) => {\n        if (result === null) {\n          throw new Error('Error adding gift card code');\n        }\n\n        setSuccessfulGiftCardSet(newSet);\n      })\n      .catch((error) => {\n        console.warn(error);\n        setGiftCardError(new Set([error.message]));\n      });\n  };\n\n  const handleRemoveGiftCard = (giftCardCode: string) => {\n    const newSet = new Set(successfulGiftCardSet);\n    newSet.delete(giftCardCode);\n    setGiftCardError(new Set());\n\n    removeGiftCardFromCart(giftCardCode)\n      .then((result) => {\n        if (result === null) {\n          throw new Error('Error removing gift card code');\n        }\n\n        setSuccessfulGiftCardSet(newSet);\n      })\n      .catch((error) => {\n        console.warn(error);\n        setGiftCardError(new Set([error.message]));\n      });\n  };\n\n  useEffect(() => {\n    const cartEvent = events.on(\n      'cart/data',\n      (payload) => {\n        const appliedGiftCards = payload?.appliedGiftCards;\n\n        if (!appliedGiftCards) {\n          // When appliedGiftCards returns null, no GiftCards are applied\n          setAppliedGiftCardsArray([]);\n          // Clear error message\n          setGiftCardError(new Set());\n          return;\n        }\n\n        const giftCardCodes = appliedGiftCards.map(({ code }) => code);\n\n        setAppliedGiftCardsArray(giftCardCodes);\n        // Clear error message\n        setGiftCardError(new Set());\n      },\n      { eager: true }\n    );\n\n    return () => {\n      cartEvent?.off();\n    };\n  }, []);\n\n  useEffect(() => {\n    setSuccessfulGiftCardSet(new Set(appliedGiftCardsArray));\n  }, [appliedGiftCardsArray]);\n\n  const appliedGiftCards = appliedGiftCardsArray.map((code, index) => (\n    <Tag key={code} className=\"coupon-code-form__applied-item\">\n      <span>{code}</span>\n      <button\n        aria-label={`${dictionary.ariaLabelRemove} ${code}`}\n        onClick={() => handleRemoveGiftCard(code)}\n        data-testid={`remove-giftcard-${index + 1}`}\n      >\n        <Icon source={Close} size={'16'} />\n      </button>\n    </Tag>\n  ));\n\n  const errorMessage =\n    giftCardError.size > 0 ? (\n      <div data-testid=\"giftcard-code-error\">\n        {Array.from(giftCardError)[0] as string}\n      </div>\n    ) : undefined;\n\n  return (\n    <CouponsComponent\n      {...props}\n      className={'cart-gift-cards'}\n      accordionSectionTitle={dictionary.giftCardTitle}\n      accordionSectionIcon={GiftCard}\n      couponCodeField={\n        <Input\n          aria-label={dictionary.ariaLabel}\n          type=\"text\"\n          placeholder={dictionary.placeholder}\n          name=\"giftCardCode\"\n          variant=\"primary\"\n          value=\"\"\n          data-testid=\"giftcard-code-input\"\n          maxLength={50}\n          error={giftCardError.size > 0}\n        />\n      }\n      applyCouponsButton={\n        <Button variant=\"secondary\">{dictionary.applyButton}</Button>\n      }\n      error={errorMessage}\n      appliedCoupons={<div>{appliedGiftCards}</div>}\n      onApplyCoupon={handleApplyGiftCard}\n    />\n  );\n};\n"],"names":["GiftCards","children","props","successfulGiftCardSet","setSuccessfulGiftCardSet","useState","appliedGiftCardsArray","setAppliedGiftCardsArray","giftCardError","setGiftCardError","dictionary","useText","handleApplyGiftCard","value","giftCardCode","newSet","applyGiftCardToCart","result","error","handleRemoveGiftCard","removeGiftCardFromCart","useEffect","cartEvent","events","payload","appliedGiftCards","giftCardCodes","code","index","jsxs","Tag","jsx","Icon","Close","errorMessage","CouponsComponent","GiftCard","Input","Button"],"mappings":"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"}