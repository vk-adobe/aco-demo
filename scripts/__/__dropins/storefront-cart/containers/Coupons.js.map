{"version":3,"file":"Coupons.js","sources":["/@dropins/storefront-cart/src/containers/Coupons/Coupons.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { HTMLAttributes, useState, useEffect } from 'preact/compat';\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { Coupons as CouponsComponent } from '@/cart/components';\nimport { Button, Input, Icon, Tag } from '@adobe-commerce/elsie/components';\nimport { Close } from '@adobe-commerce/elsie/icons';\nimport { applyCouponsToCart, ApplyCouponsStrategy } from '@/cart/api';\nimport { events } from '@adobe-commerce/event-bus';\nimport { useText } from '@adobe-commerce/elsie/i18n';\n\nexport interface CouponsProps extends HTMLAttributes<HTMLDivElement> {}\n\nexport const Coupons: Container<CouponsProps> = ({ children, ...props }) => {\n  const [successfulCouponSet, setSuccessfulCouponSet] = useState(new Set());\n  const [appliedCouponsArray, setAppliedCouponsArray] = useState<string[]>([]);\n  const [couponError, setCouponError] = useState(new Set());\n\n  const dictionary = useText({\n    applyButton: 'Cart.PriceSummary.coupon.applyAction',\n    placeholder: 'Cart.PriceSummary.coupon.placeholder',\n    ariaLabelRemove: 'Cart.PriceSummary.coupon.ariaLabelRemove',\n  });\n\n  const handleApplyCoupon = async (value: { coupon: string }) => {\n    const couponCode = value.coupon;\n\n    const newSet = new Set(successfulCouponSet);\n    newSet.add(couponCode);\n    setCouponError(new Set());\n\n    const couponCodes: string[] = Array.from(newSet) as string[];\n    applyCouponsToCart(couponCodes, ApplyCouponsStrategy.REPLACE)\n      .then((result) => {\n        if (result === null) {\n          throw new Error('Error adding coupon code');\n        }\n\n        setSuccessfulCouponSet(newSet);\n      })\n      .catch((error) => {\n        console.warn(error);\n        setCouponError(new Set([error.message]));\n      });\n  };\n\n  const handleRemoveCoupon = (couponCode: string) => {\n    const newSet = new Set(successfulCouponSet);\n    newSet.delete(couponCode);\n    setCouponError(new Set());\n\n    const couponCodes: string[] = Array.from(newSet) as string[];\n    applyCouponsToCart(couponCodes, ApplyCouponsStrategy.REPLACE)\n      .then((result) => {\n        if (result === null) {\n          throw new Error('Error removing coupon code');\n        }\n\n        setSuccessfulCouponSet(newSet);\n      })\n      .catch((error) => {\n        console.warn(error);\n        setCouponError(new Set([error.message]));\n      });\n  };\n\n  useEffect(() => {\n    const cartEvent = events.on(\n      'cart/data',\n      (payload) => {\n        const appliedCoupons = payload?.appliedCoupons;\n\n        if (!appliedCoupons) {\n          // When appliedCoupons returns null, no coupons are applied\n          setAppliedCouponsArray([]);\n          // Clear error message\n          setCouponError(new Set());\n          return;\n        }\n\n        const couponCodes = appliedCoupons.map((coupon) => coupon.code);\n\n        setAppliedCouponsArray(couponCodes);\n        // Clear error message\n        setCouponError(new Set());\n      },\n      { eager: true }\n    );\n\n    return () => {\n      cartEvent?.off();\n    };\n  }, []);\n\n  useEffect(() => {\n    setSuccessfulCouponSet(new Set(appliedCouponsArray));\n  }, [appliedCouponsArray]);\n\n  useEffect(() => {\n    const cartEvent = events.on(\n      'shipping/estimate',\n      () => {\n        setCouponError(new Set());\n      },\n      { eager: true }\n    );\n\n    return () => {\n      cartEvent?.off();\n    };\n  }, []);\n\n  const appliedCoupons = appliedCouponsArray.map((code, index) => (\n    <Tag key={code} className=\"coupon-code-form__applied-item\">\n      <span>{code}</span>\n      <button\n        aria-label={`${dictionary.ariaLabelRemove} ${code}`}\n        onClick={() => handleRemoveCoupon(code)}\n        data-testid={`remove-coupon-${index + 1}`}\n      >\n        <Icon source={Close} size={'16'} />\n      </button>\n    </Tag>\n  ));\n\n  const errorMessage =\n    couponError.size > 0 ? (\n      <div data-testid=\"coupon-code-error\">\n        {Array.from(couponError)[0] as string}\n      </div>\n    ) : undefined;\n\n  return (\n    <CouponsComponent\n      {...props}\n      couponCodeField={\n        <Input\n          aria-label={dictionary.placeholder}\n          type=\"text\"\n          placeholder={dictionary.placeholder}\n          name=\"coupon\"\n          variant=\"primary\"\n          value=\"\"\n          data-testid=\"coupon-code-input\"\n          maxLength={50}\n          error={couponError.size > 0}\n        />\n      }\n      applyCouponsButton={\n        <Button variant=\"secondary\">{dictionary.applyButton}</Button>\n      }\n      error={errorMessage}\n      appliedCoupons={<div>{appliedCoupons}</div>}\n      onApplyCoupon={handleApplyCoupon}\n    />\n  );\n};\n"],"names":["Coupons","children","props","successfulCouponSet","setSuccessfulCouponSet","useState","appliedCouponsArray","setAppliedCouponsArray","couponError","setCouponError","dictionary","useText","handleApplyCoupon","value","couponCode","newSet","couponCodes","applyCouponsToCart","ApplyCouponsStrategy","result","error","handleRemoveCoupon","useEffect","cartEvent","events","payload","appliedCoupons","coupon","code","index","jsxs","Tag","jsx","Icon","Close","errorMessage","CouponsComponent","Input","Button"],"mappings":"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"}