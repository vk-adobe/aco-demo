{"version":3,"file":"isProductConfigurationValid.js","sources":["/@dropins/storefront-pdp/src/lib/url-params.ts","/@dropins/storefront-pdp/src/data/transforms/acdl-context.ts","/@dropins/storefront-pdp/src/lib/acdl.ts","/@dropins/storefront-pdp/src/data/models/acdl-models.ts","/@dropins/storefront-pdp/src/data/transforms/product-transform.ts","/@dropins/storefront-pdp/src/api/initialize/initialize.ts","/@dropins/storefront-pdp/src/api/fetch-graphql/fetch-graphql.ts","/@dropins/storefront-pdp/src/api/getProductData/graphql/getProductData.graphql.ts","/@dropins/storefront-pdp/src/api/getProductData/getProductData.ts","/@dropins/storefront-pdp/src/api/getRefinedProduct/graphql/RefineProductQuery.graphql.ts","/@dropins/storefront-pdp/src/api/getRefinedProduct/getRefinedProduct.ts","/@dropins/storefront-pdp/src/api/fetchProductData/fetchProductData.ts","/@dropins/storefront-pdp/src/api/setProductConfigurationValues/setProductConfigurationValues.ts","/@dropins/storefront-pdp/src/api/getProductConfigurationValues/getProductConfigurationValues.ts","/@dropins/storefront-pdp/src/api/setProductConfigurationValid/setProductConfigurationValid.ts","/@dropins/storefront-pdp/src/api/isProductConfigurationValid/isProductConfigurationValid.ts"],"sourcesContent":["/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nexport function setUrlParams(\n  params: Record<string, string | number | null>\n): void {\n  const urlSearchParams = new URLSearchParams(window.location.search);\n\n  Object.entries(params).forEach(([key, value]) => {\n    if (value === null) {\n      urlSearchParams.delete(key);\n    } else {\n      urlSearchParams.set(key, String(value));\n    }\n  });\n\n  let url = window.location.pathname;\n  url += `?${urlSearchParams.toString()}`;\n  url += window.location.hash;\n\n  window.history.replaceState({}, '', url);\n}\n\nexport function getUrlParams(): Record<string, string> {\n  const urlSearchParams = new URLSearchParams(window.location.search);\n  const params: Record<string, string> = {};\n\n  urlSearchParams.forEach((value, key) => {\n    params[key] = value;\n  });\n\n  return params;\n}\n\nexport function getValidatedQuantityFromUrl(\n  defaultQuantity: number = 1\n): number {\n  const urlParams = getUrlParams() || {};\n  const quantityParam = urlParams.quantity; // 'quantity' is the key\n\n  if (quantityParam) {\n    const parsedQuantity = parseInt(quantityParam, 10);\n\n    if (\n      !isNaN(parsedQuantity) &&\n      Number.isInteger(parsedQuantity) &&\n      parsedQuantity > 0\n    ) {\n      // Return the valid quantity from the URL\n      return parsedQuantity;\n    }\n  }\n\n  // Return the default quantity if the parameter is missing, invalid, or not positive\n  return defaultQuantity;\n}\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { ProductModel } from '../models';\n\nimport { Product } from '../models/acdl-models';\n\nexport function transformProduct(product: ProductModel): Product {\n  return {\n    productId: Number(product?.externalId),\n    name: product?.name,\n    sku: product?.variantSku || product?.sku,\n    topLevelSku: product?.sku,\n    specialToDate: undefined,\n    specialFromDate: undefined,\n    newToDate: undefined,\n    newFromDate: undefined,\n    createdAt: undefined,\n    updatedAt: undefined,\n    manufacturer: undefined,\n    countryOfManufacture: undefined,\n    categories: undefined,\n    productType: product?.productType,\n    pricing: {\n      regularPrice: product?.prices?.regular?.amount || 0,\n      minimalPrice: product?.prices?.final?.minimumAmount,\n      maximalPrice: product?.prices?.final?.maximumAmount,\n      specialPrice: product?.prices?.final?.amount,\n      tierPricing: undefined,\n      currencyCode: product?.prices?.final?.currency || 'USD',\n    },\n    canonicalUrl: product?.url,\n    mainImageUrl: product?.images?.[0]?.url,\n  };\n}\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\n/* Publish functions for the Adobe Client Data Layer (ACDL) */\n\nimport { ProductModel } from '../data/models';\nimport { transformProduct } from '../data/transforms/acdl-context';\n\n/**\n * See: https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-sdk/src/contexts.ts\n */\nexport const contexts = {\n  PRODUCT_CONTEXT: 'productContext',\n};\n\n/**\n * See: https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-sdk/src/events.ts\n */\nexport const events = {\n  PRODUCT_PAGE_VIEW: 'product-page-view',\n};\n\nexport function getAdobeDataLayer() {\n  // @ts-ignore\n  window.adobeDataLayer = window.adobeDataLayer || [];\n  // @ts-ignore\n  return window.adobeDataLayer;\n}\n\n/**\n* Sets a context in the Adobe Client Data Layer (ACDL)\n* Logic based on: https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-sdk/src/Base.ts#L6\n*/\nfunction setContext(name: string, data: any) {\n  const adobeDataLayer = getAdobeDataLayer();\n\n  // Clear existing context\n  adobeDataLayer.push({\n    [name]: null,\n  });\n\n  // Set new context\n  adobeDataLayer.push({\n    [name]: data,\n  });\n}\n\n/**\n * Pushes an event to the Adobe Client Data Layer (ACDL)\n * Logic based on: https://github.com/adobe/commerce-events/blob/1973d0ce28471ef190fa06dad6359ffa0ab51db6/packages/storefront-events-sdk/src/Base.ts#L34\n */\nfunction pushEvent(event: string, additionalContext?: any) {\n  const adobeDataLayer = getAdobeDataLayer();\n\n  adobeDataLayer.push((acdl: any) => {\n    const state = acdl.getState ? acdl.getState() : {};\n\n    acdl.push({\n      event,\n      eventInfo: {\n        ...state,\n        ...additionalContext,\n      },\n    });\n  });\n}\n\n// Triggered when a product page is viewed\nexport function publishProductPageViewEvent(product: ProductModel) {\n  const productItem = transformProduct(product);\n  setContext(contexts.PRODUCT_CONTEXT, productItem);\n  pushEvent(events.PRODUCT_PAGE_VIEW);\n}\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\n/**\n * ACDL Product Types from:\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-sdk/src/types/schemas/product.ts\n */\n\nexport type Product = {\n  productId: number;\n  name: string;\n  sku: string;\n  topLevelSku?: string | null;\n  specialToDate?: string | null;\n  specialFromDate?: string | null;\n  newToDate?: string | null;\n  newFromDate?: string | null;\n  createdAt?: string | null;\n  updatedAt?: string | null;\n  manufacturer?: string | null;\n  countryOfManufacture?: string | null;\n  categories?: string[] | null;\n  productType?: ProductType;\n  pricing?: {\n    regularPrice: number;\n    minimalPrice?: number;\n    maximalPrice?: number;\n    specialPrice?: number;\n    tierPricing?: {\n      customerGroupId?: number | null;\n      qty: number;\n      value: number;\n    }[];\n    currencyCode: string | null;\n  };\n  canonicalUrl?: string | null;\n  mainImageUrl?: string | null;\n};\n\nexport enum ProductType {\n  ComplexProduct = 'complex',\n  SimpleProduct = 'simple'\n}\n\nexport enum ProductViewType {\n  ComplexProductView = 'ComplexProductView',\n  SimpleProductView = 'SimpleProductView'\n}\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\nimport { merge } from '@adobe-commerce/elsie/lib';\nimport { config } from '@/pdp/api';\nimport { ProductModel } from '@/pdp/data/models';\nimport { ProductType, ProductViewType } from '../models/acdl-models';\n\nexport function transformProductData(\n  data: any,\n  options?: {\n    preselectFirstOption?: boolean;\n  }\n): ProductModel | null {\n  const isBundle =\n    data?.options?.[0]?.values?.[0]?.__typename ===\n    'ProductViewOptionValueProduct';\n  const optionUIDs = getOptionUIDs(\n    data,\n    isBundle,\n    options?.preselectFirstOption\n  );\n  const productType =\n    data?.__typename === ProductViewType.SimpleProductView\n      ? ProductType.SimpleProduct\n      : ProductType.ComplexProduct;\n\n  const productData = data\n    ? ({\n        name: data.name,\n        sku: data.sku,\n        isBundle,\n        addToCartAllowed: data.addToCartAllowed,\n        inStock: data.inStock,\n        shortDescription: data.shortDescription,\n        metaDescription: data.metaDescription,\n        metaKeyword: data.metaKeyword,\n        metaTitle: data.metaTitle,\n        description: data.description,\n        images: transformImages(data),\n        prices: transformPrices(data, isBundle, optionUIDs),\n        attributes: transformAttributes(data),\n        options: transformOptions(data, isBundle),\n        optionUIDs,\n        url: data.url,\n        urlKey: data.urlKey,\n        externalId: data.externalId,\n        externalParentId: data.externalParentId,\n        variantSku: data.variantSku,\n        productType,\n      } as ProductModel)\n    : null;\n\n  // extend the model with custom transformer\n  return merge(\n    productData,\n    config.getConfig()?.models?.ProductDetails?.transformer?.(data) ??\n      config.getConfig()?.models?.ProductDetails?.transform?.(data)\n  );\n}\n\nfunction transformImages(data: any) {\n  return data.images\n    ?.filter((image: any) => !image.roles?.includes('hide_from_pdp'))\n    ?.map((image: any) => {\n      // Remove protocol from image URL\n      image.url = image.url.replace(/^https?:/, '');\n\n      return image;\n    });\n}\n\nfunction transformAttributes(data: any) {\n  return (\n    data.attributes\n      // only show attributes that are visible in PDP\n      ?.filter(({ roles }: any) => roles?.indexOf('visible_in_pdp') !== -1)\n      // transform attribute values\n      ?.map(({ label, value, name }: any) => {\n        return {\n          id: name,\n          label,\n          value: value.toString().split(',').join(', '),\n        };\n      })\n  );\n}\n\nfunction transformOptions(data: any, isBundle?: boolean) {\n  const { options, optionUIDs } = data;\n\n  return options?.map(({ id, title, required, multi, values }: any) => {\n    const typename = values?.[0]?.__typename;\n    let type: string = values?.[0].type;\n\n    if (type) {\n      type = type\n        .replace('COLOR_HEX', 'color')\n        .replace('TEXT', 'text')\n        .replace('IMAGE', 'image');\n    } else {\n      type = 'dropdown';\n    }\n\n    return {\n      id,\n      type,\n      typename,\n      label: title,\n      required,\n      multiple: multi,\n      items: isBundle\n        ? mapBundleOptionValues(values, optionUIDs)\n        : mapOptionValues(values, optionUIDs, type),\n    };\n  });\n}\n\nfunction mapBundleOptionValues(values: any, optionUIDs: string[]) {\n  return values\n    ?.filter(({ enabled }: any) => typeof enabled === 'undefined' || enabled)\n    .map(({ id, title, inStock, isDefault, product }: any) => {\n      return {\n        id,\n        inStock,\n        label: title,\n        selected: optionUIDs?.indexOf(id) > -1 || isDefault,\n        value: id,\n        product,\n      };\n    });\n}\n\nfunction mapOptionValues(values: any, optionUIDs: string[], type: string) {\n  return values?.map(({ id, title, inStock, value }: any) => {\n    return {\n      id,\n      inStock,\n      label: title,\n      selected: optionUIDs?.indexOf(id) > -1,\n      value:\n        type?.toLowerCase() === 'dropdown'\n          ? id\n          : value?.replace(/^https?:/, ''),\n    };\n  });\n}\n\nfunction transformPrices(\n  data: any,\n  isBundle: boolean,\n  defaultOptionUIDs?: string[]\n) {\n  const { price, priceRange, options, optionUIDs = defaultOptionUIDs } = data;\n  let { __typename: type } = data;\n\n  function getSimpleProductPrices() {\n    const regularPrice = price.regular.amount.value;\n    const finalPrice = price.final?.amount.value ?? price.regular.amount.value;\n\n    const currency =\n      price.regular.amount.currency === 'NONE' //temporary fix if there is no currency\n        ? 'USD'\n        : price?.regular.amount.currency;\n\n    return [regularPrice, finalPrice, finalPrice, currency];\n  }\n\n  function getComplexProductPrices() {\n    const finalMinimumPrice = priceRange?.minimum?.final.amount.value;\n    const finalMaximumPrice = priceRange?.maximum?.final.amount.value;\n    let regularPrice;\n\n    if (\n      priceRange?.minimum?.regular?.amount.value ===\n      priceRange?.maximum?.regular?.amount.value\n    ) {\n      regularPrice = priceRange?.minimum?.regular?.amount.value;\n    }\n\n    const currency =\n      priceRange?.minimum?.final?.amount.currency === 'NONE'\n        ? 'USD'\n        : priceRange?.minimum?.final?.amount.currency;\n\n    return [regularPrice, finalMinimumPrice, finalMaximumPrice, currency];\n  }\n\n  function getBundleProductPrice() {\n    // Currently the Catalog Service does not have support for the individual prices of the options of a fixed bundle,\n    // so the price used in UI is taken from the priceRange object.\n\n    // The dynamic bundle has full support in Catalog Service.\n    // If there are pre-selected values of the option, then the starting price is the sum of those and\n    // after each selection, the price is updated with the sum of prices for the selected options.\n    // This is not supported by default and needs to be updated in the drop-in upon each selection.\n\n    let maxSumRegular = 0;\n    let bundlePrice = 0;\n    options?.forEach((option: any) => {\n      const values = option?.values;\n      if (values && Array.isArray(values)) {\n        const regularAmounts = values\n          .map((value) => value?.product?.price?.regular?.amount?.value)\n          .filter((amount) => amount !== undefined);\n\n        const maxRegularAmount =\n          regularAmounts.length > 0 ? Math.max(...regularAmounts) : 0;\n        maxSumRegular += maxRegularAmount;\n      }\n      option?.values?.forEach((value: any) => {\n        if (optionUIDs?.includes(value.id)) {\n          bundlePrice += value?.product?.price?.final?.amount?.value;\n        }\n      });\n    });\n\n    const finalMinimumPrice = priceRange?.minimum?.final.amount.value;\n    const finalMaximumPrice = priceRange?.maximum?.final.amount.value;\n    let regularPrice;\n\n    if (\n      priceRange?.minimum?.regular?.amount.value ===\n      priceRange?.maximum?.regular?.amount.value\n    ) {\n      regularPrice = priceRange?.minimum?.regular?.amount.value;\n    }\n\n    const currency =\n      priceRange?.minimum?.final?.amount.currency === 'NONE'\n        ? 'USD'\n        : priceRange?.minimum?.final?.amount.currency;\n\n    if (isBundle && optionUIDs?.length < 1) {\n      return [regularPrice, finalMinimumPrice, finalMaximumPrice, currency];\n    }\n\n    return maxSumRegular === priceRange?.maximum.regular.amount.value\n      ? [bundlePrice, bundlePrice, bundlePrice, currency]\n      : [regularPrice, finalMinimumPrice, finalMaximumPrice, currency];\n  }\n\n  const [regularPrice, finalMinimumPrice, finalMaximumPrice, currency] =\n    type === 'SimpleProductView'\n      ? getSimpleProductPrices()\n      : isBundle\n      ? getBundleProductPrice()\n      : getComplexProductPrices();\n\n  const visible =\n    type === 'SimpleProductView'\n      ? price?.roles?.includes('visible')\n      : priceRange?.maximum?.roles?.includes('visible') &&\n        priceRange?.minimum?.roles?.includes('visible');\n\n  if (finalMaximumPrice && finalMinimumPrice === finalMaximumPrice) {\n    const hasDiscount = regularPrice && finalMinimumPrice !== regularPrice;\n\n    return {\n      regular: {\n        amount: regularPrice,\n        currency,\n        variant: hasDiscount ? 'strikethrough' : 'default',\n      },\n      final: {\n        amount: finalMaximumPrice,\n        currency,\n        variant: 'default',\n      },\n      visible,\n    };\n  }\n\n  return {\n    final: {\n      minimumAmount: finalMinimumPrice,\n      maximumAmount: finalMaximumPrice,\n      currency,\n    },\n    visible,\n  };\n}\n\nfunction getOptionUIDs(\n  data: any,\n  isBundle?: boolean,\n  preselectFirstOption?: boolean\n): string[] {\n  if (isBundle) {\n    const selections: Array<string | null> = data?.options?.map(\n      ({ values }: any) => {\n        const defaultSelection =\n          values?.find(({ isDefault }: any) => isDefault)?.id ?? null;\n        const preselectedFirstOption = preselectFirstOption\n          ? values[0].id\n          : null;\n        return defaultSelection || preselectedFirstOption;\n      }\n    );\n\n    return selections.filter((selection) => selection !== null) as string[];\n  }\n\n  return data?.optionUIDs;\n}\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { Initializer } from '@adobe-commerce/elsie/lib';\nimport { Lang } from '@adobe-commerce/elsie/i18n';\nimport { ProductModel } from '@/pdp/data/models';\nimport {\n  fetchProductData,\n  setProductConfigurationValid,\n  setProductConfigurationValues,\n} from '@/pdp/api';\nimport { events } from '@adobe-commerce/event-bus';\nimport {\n  getUrlParams,\n  getValidatedQuantityFromUrl,\n} from '@/pdp/lib/url-params';\nimport { publishProductPageViewEvent } from '@/pdp/lib/acdl';\nimport { transformProductData } from '@/pdp/data/transforms/product-transform';\n\ntype ConfigProps = {\n  langDefinitions?: Lang;\n  defaultLocale?: string;\n  sku?: string;\n  acdl?: boolean;\n  anchors?: string[];\n  persistURLParams?: boolean;\n  preselectFirstOption?: boolean;\n  optionsUIDs?: string[];\n  models?: {\n    [name: string]: {\n      initialData: any;\n      /** @deprecated Use \"transformer\" instead */\n      transform?: (data?: ProductModel) => ProductModel;\n      transformer?: (data?: ProductModel) => ProductModel;\n      fallbackData?: (\n        parentProduct: any,\n        simpleProduct: ProductModel\n      ) => ProductModel;\n    };\n  };\n};\n\nexport const initialize = new Initializer<ConfigProps>({\n  init: async (_config) => {\n    const initialData = _config?.models?.ProductDetails?.initialData;\n\n    // Get URL parameters safely\n    const urlParams = getUrlParams() || {};\n\n    // Get optionsUIDs from URL params or config\n    const optionsUIDs =\n      urlParams.optionsUIDs?.split(',') || initialData?.optionsUIDs;\n\n    // Get and validate quantity from URL params\n    const initialQuantity = getValidatedQuantityFromUrl(1); // Default quantity to 1 - Ensures backward compatibility\n\n    // Set default config\n    const defaultConfig: ConfigProps = {\n      defaultLocale: 'en-US',\n      persistURLParams: false,\n      acdl: false,\n      optionsUIDs,\n    };\n\n    const config = { ...defaultConfig, ..._config };\n\n    initialize.config.setConfig({ ...config });\n\n    if (config?.sku) {\n      // Get PDP data\n      const data = initialData\n        ? transformProductData(initialData)\n        : await fetchProductData(config.sku, {\n            preselectFirstOption: config.preselectFirstOption,\n          });\n\n      // Emit PDP initial data\n      events.emit('pdp/data', data);\n\n      // Set default values for product configuration\n      const defaultValues = {\n        sku: config.sku,\n        quantity: initialQuantity, // Use the determined quantity from URL params or default to 1\n        optionsUIDs: data?.optionUIDs,\n      };\n\n      setProductConfigurationValues(() => ({ ...defaultValues }));\n\n      setProductConfigurationValid(() => {\n        // configurable product, check if all options are selected\n        if (data?.options) {\n          // all selections should be made\n          return data.options.length === data?.optionUIDs?.length;\n        }\n\n        // simple product\n        return true;\n      });\n\n      // Publish ACDL event\n      if (config.acdl && data) {\n        publishProductPageViewEvent(data);\n      }\n    }\n  },\n\n  listeners: () => [\n    events.on('locale', async () => {\n      const { sku } = initialize.config.getConfig();\n\n      if (sku) {\n        const next = await fetchProductData(sku);\n        events.emit('pdp/data', next);\n      }\n    }),\n  ],\n});\n\nexport const config = initialize.config;\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { FetchGraphQL } from '@adobe-commerce/fetch-graphql';\n\nexport const {\n  setEndpoint,\n  setFetchGraphQlHeader,\n  removeFetchGraphQlHeader,\n  setFetchGraphQlHeaders,\n  fetchGraphQl,\n  getConfig,\n} = new FetchGraphQL().getMethods();\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { PRODUCT_FRAGMENT } from '@/pdp/api/graphql/ProductFragment.graphql';\n\nexport const GET_PRODUCT_DATA = `\nquery GET_PRODUCT_DATA($skus: [String]) {\n    products(skus: $skus) {\n        ...PRODUCT_FRAGMENT\n    }\n}\n\n${PRODUCT_FRAGMENT}\n`;\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { fetchGraphQl } from '@/pdp/api';\nimport { ProductModel } from '@/pdp/data/models';\nimport { transformProductData } from '@/pdp/data/transforms';\nimport { GET_PRODUCT_DATA } from './graphql/getProductData.graphql';\n\nexport const getProductData = async (\n  sku: string,\n  options?: {\n    preselectFirstOption?: boolean;\n    optionsUIDs?: string[];\n  },\n  raw?: boolean\n): Promise<ProductModel | null> => {\n  const { data } = await fetchGraphQl(GET_PRODUCT_DATA, {\n    method: 'GET',\n    variables: { skus: [sku] },\n  });\n\n  const product = data?.products?.[0];\n\n  // If optionsUIDs are provided, override the optionsUIDs from the response\n  if (options?.optionsUIDs) {\n    product.optionUIDs = options.optionsUIDs;\n  }\n\n  if (!product) {\n    return null;\n  }\n  return raw\n    ? product\n    : transformProductData(product, {\n        preselectFirstOption: options?.preselectFirstOption,\n      });\n};\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { PRODUCT_FRAGMENT } from '@/pdp/api/graphql/ProductFragment.graphql';\n\nexport const REFINE_PRODUCT_QUERY = `\nquery REFINE_PRODUCT_QUERY(\n    $optionIds: [String!]!\n    $sku: String!\n) {\n    # Refined Product\n    refineProduct(\n        optionIds: $optionIds \n        sku: $sku\n    ) {\n        ...PRODUCT_FRAGMENT\n    }\n\n    # Parent Product\n    products(skus: [$sku]) {\n        ...PRODUCT_FRAGMENT\n    }\n\n    # %extendedPlaceholder%\n}\n\n${PRODUCT_FRAGMENT}\n`;\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2023 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { fetchGraphQl, config } from '@/pdp/api';\nimport { ProductModel } from '@/pdp/data/models';\nimport { transformProductData } from '@/pdp/data/transforms';\nimport { REFINE_PRODUCT_QUERY } from './graphql/RefineProductQuery.graphql';\n\nasync function getProductData(sku: string, optionUIDs: string[]): Promise<any> {\n  const optionPairCombinations = getPairCombination(optionUIDs);\n  const optionQueries = getProductOptionQuery(optionPairCombinations, sku);\n\n  const mergedQueries = REFINE_PRODUCT_QUERY.replace(\n    '# %extendedPlaceholder%',\n    optionQueries\n  );\n\n  const { data } = await fetchGraphQl(mergedQueries, {\n    method: 'GET',\n    variables: { optionIds: optionUIDs, sku },\n  });\n  return data;\n}\n\nexport const getRefinedProduct = async (\n  sku: string,\n  optionUIDs: string[],\n  anchorOptions?: string[],\n  raw?: boolean\n): Promise<ProductModel | null> => {\n  const data = await getProductData(sku, optionUIDs);\n  if (!data) return null;\n\n  let { products, refineProduct, ...refinedOptions } = data;\n\n  const parent = products?.[0];\n\n  const options = mergeRefinedOptions(\n    Object.values(refinedOptions),\n    parent.options,\n    anchorOptions\n  );\n\n  // needed when anchor options exist\n  if (anchorOptions?.length && refineProduct === null) {\n    optionUIDs = updateSelections(options, optionUIDs, anchorOptions);\n    const updatedRefinedData = await getProductData(sku, optionUIDs);\n    refineProduct = updatedRefinedData?.refineProduct;\n  }\n\n  const response = {\n    ...(refineProduct || parent),\n    sku: parent.sku,\n    name: parent.name,\n    externalParentId: parent?.externalId,\n    options,\n    optionUIDs,\n    variantSku:\n      refineProduct?.__typename === 'SimpleProductView'\n        ? refineProduct?.sku\n        : undefined,\n  };\n\n  const refinedData = raw ? response : transformProductData(response);\n\n  const fallback = config?.getConfig()?.models?.ProductDetails?.fallbackData;\n\n  if (fallback) {\n    return fallback(parent, refinedData!);\n  }\n\n  return refinedData;\n};\n\nfunction getPairCombination(arr: string[]): string[][] {\n  if (arr.length < 2) {\n    return [arr];\n  }\n\n  const result: string[][] = [];\n\n  arr.forEach((item) => {\n    const temp: string[] = [];\n\n    arr.forEach((item2) => {\n      if (item !== item2) {\n        temp.push(item2);\n      }\n    });\n\n    result.push(temp);\n  });\n\n  return result;\n}\n\nfunction getProductOptionQuery(optionUIDs: string[][], sku: string): string {\n  return optionUIDs\n    .map((ids: string[], i: number) => {\n      return `\n          ProductOption${i}: refineProduct(\n            optionIds: [\n              ${ids.map((id) => `\"${id}\"`).join(', ')}\n            ]\n            sku: \"${sku}\"\n          ) {\n            ... on ComplexProductView {\n              options {\n                ...PRODUCT_OPTION_FRAGMENT\n              }\n            }\n          }\n        `;\n    })\n    .join('');\n}\n\nfunction mergeRefinedOptions(\n  options: {},\n  parent: [] = [],\n  anchorOptions?: string[]\n) {\n  // flat _refined[].options[] to _refinedOptions[]\n  const refinedOptions: any = Object.values(options)\n    .filter((x) => !!x)\n    .reduce((acc: any, curr: any) => {\n      if (!curr.options) return [...acc];\n\n      return [...acc, ...curr.options];\n    }, []);\n\n  // Create a map to store items by their id from original\n  const map = new Map(parent.map((item: any) => [item.id, item]));\n\n  // Iterate through refinedOptions and merge items\n  refinedOptions.forEach((current: any) => {\n    // anchor options should display all values, so no merge is performed\n    if (anchorOptions?.includes(current.id)) {\n      return;\n    }\n\n    map.set(current.id, current);\n  });\n\n  return [...map.values()];\n}\n\nfunction updateSelections(\n  options: any[],\n  optionsUIDs: string[],\n  anchorOptions: string[]\n): string[] {\n  const updatedOptionsUIDs: string[] = [];\n\n  let optionValue: string;\n  options.forEach((option: any) => {\n    if (anchorOptions.includes(option.id)) {\n      optionValue =\n        option.values?.find((value: any) => optionsUIDs.includes(value?.id))\n          ?.id || option.values[0]?.id;\n    } else {\n      optionValue = option.values[0]?.id; // TODO check if we should use default value instead\n    }\n    updatedOptionsUIDs.push(optionValue);\n  });\n  return updatedOptionsUIDs;\n}\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2024 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { getProductData, getRefinedProduct, config } from '@/pdp/api';\n\nexport type Options = {\n  anchors?: string[];\n  optionsUIDs?: string[];\n  preselectFirstOption?: boolean;\n  isBundle?: boolean;\n  skipTransform?: boolean;\n};\n\nexport const fetchProductData = async (sku: string, options?: Options) => {\n  // Get the default configuration values\n  const { anchors: defaultAnchors, optionsUIDs: defaultOptionsUIDs } =\n    config.getConfig();\n\n  // Destructure the options object\n  const {\n    optionsUIDs = defaultOptionsUIDs,\n    anchors = defaultAnchors,\n    preselectFirstOption,\n    isBundle,\n    skipTransform,\n  } = options ?? {};\n\n  // ❗️ Warning ❗️\n  // If we have default selections, but we cannot determine that the product is of type bundle, then the response is going to result in null objects and error(s).\n  // Only the `products` object will be populated correctly, the `ProductOption${i}` and `refinedProduct` will be set as null.\n  // This does not affect the UI, but the error message(s) can be detected by 3rd party tools that the client might be using.\n  // This is accepted as a known behaviour, since a bundle product does not have variants.\n  // However, if initialData is passed from the integration layer, then we can determine if the product is a bundle and set the isBundle flag accordingly.\n  return !isBundle && optionsUIDs\n    ? await getRefinedProduct(sku, optionsUIDs, anchors, skipTransform)\n    : await getProductData(\n        sku,\n        {\n          preselectFirstOption,\n          optionsUIDs,\n        },\n        skipTransform\n      );\n};\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2024 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { events } from '@adobe-commerce/event-bus';\nimport { ValuesModel } from '@/pdp/data/models';\nimport { getProductConfigurationValues } from '@/pdp/api';\n\nexport const setProductConfigurationValues = (\n  callback: (prev: ValuesModel) => ValuesModel\n) => {\n  const prev = getProductConfigurationValues();\n\n  const next = callback(prev as ValuesModel);\n\n  events.emit('pdp/values', { ...next });\n};\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2024 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { events } from '@adobe-commerce/event-bus';\nimport { ValuesModel } from '@/pdp/data/models';\n\nexport const getProductConfigurationValues =  (): ValuesModel | null => {\n  return events._lastEvent['pdp/values']?.payload ?? null;\n};\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2024 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { events } from '@adobe-commerce/event-bus';\nimport { isProductConfigurationValid } from '@/pdp/api';\n\nexport const setProductConfigurationValid = (\n  callback: (prev: boolean) => boolean\n) => {\n  const prev = isProductConfigurationValid();\n\n  const next = callback(prev as boolean);\n\n  events.emit('pdp/valid', next);\n};\n","/**\n * ADOBE CONFIDENTIAL\n * __________________\n * Copyright 2024 Adobe\n * All Rights Reserved.\n * __________________\n * NOTICE: All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n */\n\nimport { events } from '@adobe-commerce/event-bus';\n\nexport const isProductConfigurationValid = (): boolean | null => {\n  return events._lastEvent['pdp/valid']?.payload ?? null;\n};\n"],"names":["setUrlParams","params","urlSearchParams","key","value","url","getUrlParams","getValidatedQuantityFromUrl","defaultQuantity","quantityParam","parsedQuantity","transformProduct","product","_b","_a","_d","_c","_f","_e","_h","_g","_j","_i","_l","_k","contexts","events","getAdobeDataLayer","setContext","name","data","adobeDataLayer","pushEvent","event","additionalContext","acdl","state","publishProductPageViewEvent","productItem","ProductType","ProductViewType","transformProductData","options","isBundle","optionUIDs","getOptionUIDs","productType","productData","transformImages","transformPrices","transformAttributes","transformOptions","merge","config","image","roles","label","id","title","required","multi","values","typename","type","mapBundleOptionValues","mapOptionValues","enabled","inStock","isDefault","defaultOptionUIDs","price","priceRange","getSimpleProductPrices","regularPrice","finalPrice","currency","getComplexProductPrices","finalMinimumPrice","finalMaximumPrice","getBundleProductPrice","maxSumRegular","bundlePrice","option","regularAmounts","amount","maxRegularAmount","visible","preselectFirstOption","defaultSelection","preselectedFirstOption","selection","initialize","Initializer","_config","initialData","optionsUIDs","initialQuantity","fetchProductData","defaultValues","setProductConfigurationValues","setProductConfigurationValid","sku","next","setEndpoint","setFetchGraphQlHeader","removeFetchGraphQlHeader","setFetchGraphQlHeaders","fetchGraphQl","getConfig","FetchGraphQL","GET_PRODUCT_DATA","PRODUCT_FRAGMENT","getProductData","raw","REFINE_PRODUCT_QUERY","optionPairCombinations","getPairCombination","optionQueries","getProductOptionQuery","mergedQueries","getRefinedProduct","anchorOptions","products","refineProduct","refinedOptions","parent","mergeRefinedOptions","updateSelections","updatedRefinedData","response","refinedData","fallback","arr","result","item","temp","item2","ids","x","acc","curr","map","current","updatedOptionsUIDs","optionValue","defaultAnchors","defaultOptionsUIDs","anchors","skipTransform","callback","prev","getProductConfigurationValues","isProductConfigurationValid"],"mappings":"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"}